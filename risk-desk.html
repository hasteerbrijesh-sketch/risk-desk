<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>RISK DESK</title>

<!-- PWA Meta Tags -->
<meta name="application-name" content="RISK DESK">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RISK DESK">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07090f">
<meta name="description" content="Personal Nifty Options Risk Dashboard ‚Äî Black-Scholes Greeks, Live Prices, Multi-device Sync">

<!-- PWA Manifest (inline as data URI so single-file works) -->
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22RISK+DESK%22%2C%22short_name%22%3A%22RISK+DESK%22%2C%22description%22%3A%22Nifty+Options+Risk+Dashboard%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2307090f%22%2C%22theme_color%22%3A%22%2307090f%22%2C%22orientation%22%3A%22any%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg+xmlns%3D%2527http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%2527+viewBox%3D%270+0+512+512%2527%253E%253Crect+width%3D%2527512%2527+height%3D%2527512%2527+fill%3D%2527%252307090f%2527%2F%253E%253Ctext+x%3D%2527256%2527+y%3D%2527320%2527+font-size%3D%2527240%2527+text-anchor%3D%2527middle%2527+fill%3D%2527%252300c8ff%2527%253E%25E2%25AC%25A1%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any+maskable%22%7D%5D%7D">

<!-- Apple touch icon (inline SVG ‚Üí PNG-like) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%2307090f'/><text x='256' y='320' font-size='240' text-anchor='middle' fill='%2300c8ff'>‚¨°</text></svg>">

<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090f;--bg2:#0c1018;--bg3:#111620;--bg4:#161c28;
  --border:#1c2535;--border2:#26354f;
  --accent:#00c8ff;--accent2:#0099cc;
  --green:#00e676;--green2:#00a854;
  --red:#ff3b55;--red2:#b01f35;
  --orange:#ffaa00;--orange2:#c47f00;
  --purple:#c084fc;--yellow:#ffe566;
  --text:#dde4f0;--text2:#7e90ab;--text3:#3d5068;
  --mono:'Space Mono',monospace;--sans:'DM Sans',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,.025) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;padding:16px 20px;max-width:1720px;margin:0 auto;}

.nav{display:flex;gap:2px;margin-bottom:16px;background:var(--bg2);border:1px solid var(--border);padding:4px;}
.nav-tab{padding:8px 18px;font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--text2);cursor:pointer;border:1px solid transparent;transition:all .2s;}
.nav-tab:hover{color:var(--text);background:var(--bg3);}
.nav-tab.active{color:var(--accent);background:var(--bg3);border-color:var(--accent2);}
.page{display:none;}.page.active{display:block;}

.hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:var(--bg2);border:1px solid var(--border);border-bottom:2px solid var(--accent);margin-bottom:14px;position:relative;overflow:hidden;}
.hdr::before{content:'';position:absolute;bottom:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scan 4s linear infinite;}
@keyframes scan{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.hdr-l h1{font-family:var(--mono);font-size:14px;color:var(--accent);letter-spacing:3px;}
.hdr-l p{font-size:10px;color:var(--text3);margin-top:2px;letter-spacing:1px;}
.hdr-r{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.live-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 1.5s ease-in-out infinite;display:inline-block;margin-right:5px;}
.live-dot.red{background:var(--red);}
.live-dot.orange{background:var(--orange);}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
.badge{font-family:var(--mono);font-size:9px;padding:4px 9px;letter-spacing:1px;white-space:nowrap;}
.badge-green{background:rgba(0,230,118,.1);border:1px solid var(--green2);color:var(--green);}
.badge-orange{background:rgba(255,170,0,.1);border:1px solid var(--orange2);color:var(--orange);}
.badge-red{background:rgba(255,59,85,.1);border:1px solid var(--red2);color:var(--red);}
.badge-blue{background:rgba(0,200,255,.1);border:1px solid var(--accent2);color:var(--accent);}
.badge-gray{background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--text2);}
.badge-accent{background:rgba(0,200,255,.1);border:1px solid var(--accent2);color:var(--accent);}
#clock{font-family:var(--mono);font-size:11px;color:var(--text2);}

.card{background:var(--bg2);border:1px solid var(--border);padding:16px;}
.card-accent{border-top:2px solid var(--accent);}
.card-green{border-top:2px solid var(--green);}
.card-red{border-top:2px solid var(--red);}
.card-orange{border-top:2px solid var(--orange);}
.card-purple{border-top:2px solid var(--purple);}

.stitle{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:3px;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.stitle::after{content:'';flex:1;height:1px;background:var(--border);}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
.g12{display:grid;grid-template-columns:1fr 2fr;gap:12px;}
.g21{display:grid;grid-template-columns:2fr 1fr;gap:12px;}
.mb12{margin-bottom:12px;}.mb8{margin-bottom:8px;}.mt8{margin-top:8px;}.mt6{margin-top:6px;}

.kpi-label{font-family:var(--mono);font-size:8px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.kpi-val{font-family:var(--mono);font-size:26px;font-weight:700;line-height:1;}
.kpi-sub{font-size:10px;color:var(--text2);margin-top:5px;}
.kpi-sm{font-size:17px;}.kpi-xs{font-size:13px;}
.green{color:var(--green);}.red{color:var(--red);}.orange{color:var(--orange);}.accent{color:var(--accent);}.purple{color:var(--purple);}

.tbl{width:100%;border-collapse:collapse;font-size:11px;}
.tbl th{font-family:var(--mono);font-size:8px;letter-spacing:1px;color:var(--text3);background:var(--bg3);padding:7px 9px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
.tbl td{padding:8px 9px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text2);}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:rgba(255,255,255,.02);}
.tbl .mono{font-family:var(--mono);font-size:10px;}
.tbl .bold{font-weight:700;color:var(--text);}
.tbl .total-row td{background:var(--bg3);font-weight:700;color:var(--text);font-family:var(--mono);font-size:10px;}
.chip{display:inline-block;font-family:var(--mono);font-size:8px;padding:2px 6px;letter-spacing:1px;}

.inp-group{display:flex;flex-direction:column;gap:4px;}
.inp-group label{font-family:var(--mono);font-size:8px;color:var(--text3);letter-spacing:2px;}
.inp-group input,.inp-group select{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:6px 9px;outline:none;width:100%;transition:border-color .2s;}
.inp-group input:focus,.inp-group select:focus{border-color:var(--accent);}
.inp-group select option{background:var(--bg3);}
.inp-hint{font-size:9px;color:var(--text3);}

.btn{font-family:var(--mono);font-size:10px;padding:8px 16px;letter-spacing:2px;cursor:pointer;border:none;transition:all .2s;}
.btn-primary{background:var(--accent);color:var(--bg);}.btn-primary:hover{background:#fff;}
.btn-danger{background:var(--red);color:#fff;}.btn-danger:hover{background:#ff6b7f;}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2);}.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-green{background:var(--green2);color:#fff;}.btn-green:hover{background:var(--green);}
.btn-orange{background:var(--orange2);color:#fff;}.btn-orange:hover{background:var(--orange);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

.gauge{height:6px;background:var(--border);border-radius:1px;overflow:hidden;margin-top:5px;}
.gauge-fill{height:100%;border-radius:1px;transition:width .4s ease;}
.gauge-green{background:var(--green);}.gauge-orange{background:var(--orange);}.gauge-red{background:var(--red);}.gauge-accent{background:var(--accent);}

.range-track{height:10px;border-radius:1px;background:linear-gradient(90deg,#b01f35 0%,#c47f00 22%,#00a854 40%,#00e676 50%,#00a854 60%,#c47f00 78%,#b01f35 100%);position:relative;margin:28px 0 10px;}
.range-pin{position:absolute;top:-20px;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;transition:left .4s;}
.range-pin-lbl{font-family:var(--mono);font-size:8px;background:rgba(0,200,255,.15);border:1px solid var(--accent2);color:var(--accent);padding:2px 5px;white-space:nowrap;}
.range-arrow{width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:6px solid var(--accent);}

/* SCENARIO TABLE */
.scen-tbl{width:100%;border-collapse:collapse;font-size:10px;}
.scen-tbl th{font-family:var(--mono);font-size:8px;color:var(--text3);background:var(--bg3);padding:6px 7px;text-align:center;border:1px solid var(--border);white-space:nowrap;}
.scen-tbl th.lbl{text-align:left;}
.scen-tbl td{padding:5px 7px;text-align:right;border:1px solid var(--border);font-family:var(--mono);color:var(--text2);}
.scen-tbl td.lbl{text-align:left;color:var(--text2);font-family:var(--sans);font-size:10px;white-space:nowrap;}
.scen-tbl td.pos{color:var(--green);}.scen-tbl td.neg{color:var(--red);}.scen-tbl td.zero{color:var(--text3);}
.scen-tbl tr.total-row td{background:var(--bg3);font-weight:700;color:var(--text);}
.scen-tbl td.highlight{background:rgba(0,200,255,.06);}
.scen-tbl th.highlight{background:rgba(0,200,255,.12);color:var(--accent);}

/* Greeks change highlight */
.delta-improving{color:var(--green)!important;}
.delta-worsening{color:var(--red)!important;}

.alert-box{padding:9px 12px;border-left:3px solid;font-size:11px;margin-bottom:8px;line-height:1.5;}
.alert-box.danger{border-color:var(--red);background:rgba(255,59,85,.06);}
.alert-box.warning{border-color:var(--orange);background:rgba(255,170,0,.06);}
.alert-box.ok{border-color:var(--green);background:rgba(0,230,118,.06);}
.alert-box.info{border-color:var(--accent);background:rgba(0,200,255,.06);}

.cal-wrap{display:flex;gap:2px;flex-wrap:wrap;margin:10px 0 5px;}
.cal-day{width:26px;height:22px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:8px;border:1px solid transparent;}
.cal-elapsed{background:var(--bg3);color:var(--text3);}
.cal-today{background:var(--accent);color:var(--bg);font-weight:700;}
.cal-remaining{background:var(--bg4);border-color:var(--border);color:var(--text3);}
.cal-danger{background:rgba(255,59,85,.15);border-color:var(--red2);color:var(--red);}
.cal-expiry{background:rgba(255,170,0,.2);border-color:var(--orange2);color:var(--orange);font-weight:700;}

/* LIVE PRICE PANEL */
.live-panel{background:var(--bg2);border:1px solid var(--border);border-top:2px solid var(--green);padding:14px;margin-bottom:12px;}
.live-status-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
.price-ticker{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);padding:6px 12px;}
.price-ticker .sym{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:2px;}
.price-ticker .price{font-family:var(--mono);font-size:14px;font-weight:700;}
.price-ticker .chg{font-family:var(--mono);font-size:9px;}
.price-ticker .chg.up{color:var(--green);}.price-ticker .chg.dn{color:var(--red);}
.fetching{opacity:.5;}

.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--accent2);padding:22px;width:620px;max-width:95vw;max-height:90vh;overflow-y:auto;}
.modal h3{font-family:var(--mono);color:var(--accent);font-size:12px;letter-spacing:2px;margin-bottom:14px;}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);}

.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--green2);padding:9px 16px;font-family:var(--mono);font-size:10px;color:var(--green);z-index:9999;opacity:0;transform:translateY(8px);transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.error{border-color:var(--red2);color:var(--red);}

/* Greeks explanation tooltip */
.greek-explain{font-size:9px;color:var(--text3);margin-top:4px;line-height:1.4;}
.arrow-up::before{content:'‚ñ≤ ';}.arrow-dn::before{content:'‚ñº ';}

/* ‚ïê‚ïê‚ïê MOBILE / PWA STYLES ‚ïê‚ïê‚ïê */
@media (max-width: 768px) {
  .wrap{padding:8px 10px;}
  .hdr{padding:10px 12px;flex-wrap:wrap;gap:8px;}
  .hdr-l h1{font-size:11px;letter-spacing:2px;}
  .hdr-r{gap:6px;}
  .nav{overflow-x:auto;-webkit-overflow-scrolling:touch;gap:0;}
  .nav-tab{padding:7px 11px;font-size:8px;letter-spacing:1px;white-space:nowrap;}
  .g2,.g3,.g4,.g5,.g12,.g21{grid-template-columns:1fr;}
  .g2.force2{grid-template-columns:1fr 1fr;}
  .kpi-val{font-size:20px;}
  .tbl{font-size:10px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .scen-tbl{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .modal{width:95vw;padding:14px;}
  .modal-grid{grid-template-columns:1fr;}
  .btn{padding:9px 12px;font-size:9px;}
  .card{padding:12px;}
  #clock{display:none;}
}
/* Safe area for notch phones */
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
/* Prevent zoom on input tap (iOS) */
input,select{font-size:16px !important;}
.tbl input,.modal input,.modal select{font-size:14px !important;}

</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-l">
    <h1>‚¨° RISK DESK</h1>
    <p>NIFTY OPTIONS ¬∑ BLACK-SCHOLES GREEKS ¬∑ LIVE VIX ¬∑ MULTI-DEVICE SYNC</p>
  </div>
  <div class="hdr-r">
    <span id="live-status-badge" class="badge badge-gray"><span class="live-dot orange"></span>PRICES: MANUAL</span>
    <span id="vix-badge" class="badge badge-orange">VIX: ‚Äî</span>
    <span id="nifty-badge" class="badge badge-blue">NIFTY: ‚Äî</span>
    <button class="btn btn-green" style="padding:5px 12px;font-size:9px;" onclick="fetchLivePrices()">‚ü≥ FETCH LIVE</button>
    <button class="btn btn-ghost" style="padding:5px 12px;font-size:9px;" onclick="generatePDF()">‚Üì PDF REPORT</button>
    <span id="clock"></span>
  </div>
</div>

<!-- NAV -->
<div class="nav">
  <div class="nav-tab active" onclick="switchPage('dashboard')">DASHBOARD</div>
  <div class="nav-tab" onclick="switchPage('portfolio')">POSITIONS</div>
  <div class="nav-tab" onclick="switchPage('equity')">EQUITY BOOK</div>
  <div class="nav-tab" onclick="switchPage('scenario')">SCENARIO P&L</div>
  <div class="nav-tab" onclick="switchPage('greeks')">GREEKS DEEP DIVE</div>
  <div class="nav-tab" onclick="switchPage('alerts')">ALERTS & LEVELS</div>
  <div class="nav-tab" onclick="switchPage('settings')">SETTINGS</div>
  <div class="nav-tab" id="nav-m2m" onclick="switchPage('m2m')" style="color:var(--green);border-color:var(--green2);">‚Çπ DAILY M2M</div>
  <div class="nav-tab" id="nav-sync" onclick="switchPage('sync')" style="color:var(--orange);border-color:var(--orange2);">‚òÅ SYNC SETUP</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD -->
<div id="page-dashboard" class="page active">

  <!-- LIVE PRICE PANEL -->
  <div class="live-panel">
    <div class="live-status-bar">
      <span style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:2px;">LIVE PRICES</span>
      <div id="ticker-wrap" style="display:flex;gap:6px;flex-wrap:wrap;flex:1;"></div>
      <span id="last-fetch-time" style="font-family:var(--mono);font-size:9px;color:var(--text3);"></span>
      <button class="btn btn-green" style="padding:4px 10px;font-size:8px;" onclick="fetchLivePrices()">‚ü≥ REFRESH</button>
      <button class="btn btn-ghost" style="padding:4px 10px;font-size:8px;" onclick="switchPage('settings')">+ ADD SYMBOLS</button>
    </div>
    <div id="fetch-note" style="font-size:9px;color:var(--text3);line-height:1.5;"></div>
  </div>

  <!-- KPI STRIP -->
  <div class="g5 mb12">
    <div class="card card-accent">
      <div class="kpi-label">Nifty Spot</div>
      <div class="kpi-val accent" id="d-nifty">‚Äî</div>
      <div class="kpi-sub" id="d-nifty-sub">1 SD range</div>
    </div>
    <div class="card card-orange">
      <div class="kpi-label">India VIX</div>
      <div class="kpi-val" id="d-vix" style="color:var(--orange)">‚Äî</div>
      <div class="kpi-sub" id="d-vix-regime">‚Äî</div>
    </div>
    <div class="card card-green">
      <div class="kpi-label">Total Opt/Fut P&L ‚Çπ</div>
      <div class="kpi-val kpi-sm" id="d-opt-pnl">‚Äî</div>
      <div class="kpi-sub">Actual (LTP ‚àí Trade) √ó Qty</div>
    </div>
    <div class="card card-purple">
      <div class="kpi-label">Equity P&L ‚Çπ</div>
      <div class="kpi-val kpi-sm" id="d-eq-pnl">‚Äî</div>
      <div class="kpi-sub">Unrealised MTM</div>
    </div>
    <div class="card" style="border-top:2px solid var(--yellow)">
      <div class="kpi-label">Combined P&L ‚Çπ</div>
      <div class="kpi-val kpi-sm" id="d-total-pnl" style="color:var(--yellow)">‚Äî</div>
      <div class="kpi-sub">Options + Equity</div>
    </div>
  </div>

  <!-- EXPOSURE + VIX -->
  <div class="g21 mb12">
    <div class="card card-accent">
      <div class="stitle">CURRENT EXPOSURE ‚Äî BLACK-SCHOLES GREEKS AT SPOT</div>
      <div class="g4">
        <div><div class="kpi-label">Net Delta (units)</div><div class="kpi-val kpi-xs accent" id="d-net-delta">‚Äî</div><div class="greek-explain">Total directional exposure. +ve = bullish, -ve = bearish.</div></div>
        <div><div class="kpi-label">Delta Exposure ‚Çπ</div><div class="kpi-val kpi-xs" id="d-delta-exp">‚Äî</div><div class="greek-explain">‚Çπ change per 1pt Nifty move. Delta √ó Spot.</div></div>
        <div><div class="kpi-label">Net Gamma</div><div class="kpi-val kpi-xs red" id="d-gamma">‚Äî</div><div class="greek-explain">How fast delta changes per 1pt move. Negative = delta hurts you on big moves.</div></div>
        <div><div class="kpi-label">Theta / Day ‚Çπ</div><div class="kpi-val kpi-xs green" id="d-theta">‚Äî</div><div class="greek-explain">Daily premium decay earned (+) or lost (‚àí).</div></div>
        <div><div class="kpi-label">Vega / 1% IV ‚Çπ</div><div class="kpi-val kpi-xs" id="d-vega">‚Äî</div><div class="greek-explain">‚Çπ impact if VIX moves 1%. Negative = VIX spike hurts you.</div></div>
        <div><div class="kpi-label">Equity Delta ‚Çπ</div><div class="kpi-val kpi-xs" id="d-eq-delta">‚Äî</div><div class="greek-explain">NiftyBees + ETF directional exposure.</div></div>
        <div><div class="kpi-label">Beta-Adj Equity ‚Çπ</div><div class="kpi-val kpi-xs" id="d-eq-beta-delta">‚Äî</div><div class="greek-explain">Beta-weighted equity market exposure.</div></div>
        <div><div class="kpi-label">P&L per 1% Move ‚Çπ</div><div class="kpi-val kpi-xs orange" id="d-pnl-1pct">‚Äî</div><div class="greek-explain">Combined options + equity sensitivity to 1% Nifty move.</div></div>
      </div>
    </div>
    <div>
      <div class="card card-orange mb12">
        <div class="stitle">VIX REGIME</div>
        <div class="kpi-val" id="d-vix2" style="color:var(--orange);font-size:32px;">‚Äî</div>
        <div id="d-vix-badge2" class="badge badge-green mt6" style="display:inline-block;">‚Äî</div>
        <div id="d-vix-action" class="alert-box ok mt6" style="font-size:10px;"></div>
      </div>
      <div class="card card-green">
        <div class="stitle">DTE & CREDIT</div>
        <div style="display:flex;justify-content:space-between;align-items:flex-end;">
          <div><div class="kpi-label">Days to Expiry</div><div class="kpi-val kpi-sm" id="d-dte">‚Äî</div></div>
          <div style="text-align:right;"><div class="kpi-label">Net Credit ‚Çπ</div><div class="kpi-val kpi-xs green" id="d-credit">‚Äî</div></div>
        </div>
        <div class="gauge mt6"><div class="gauge-fill gauge-accent" id="d-dte-bar" style="width:70%;"></div></div>
        <div id="d-dte-note" class="kpi-sub mt6">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- RANGE BAR -->
  <div class="card mb12">
    <div class="stitle">POSITION RANGE GAUGE</div>
    <div style="padding:0 16px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px;" id="range-ticks"></div>
      <div class="range-track"><div class="range-pin" id="range-pin" style="left:50%"><div class="range-pin-lbl" id="range-pin-lbl">‚Äî</div><div class="range-arrow"></div></div></div>
      <div style="display:flex;justify-content:space-between;">
        <span style="font-size:9px;color:var(--red);font-family:var(--mono);">EXIT SHORT PE ‚Üë</span>
        <span style="font-size:9px;color:var(--orange);font-family:var(--mono);">CAUTION</span>
        <span style="font-size:9px;color:var(--green);font-family:var(--mono);">SWEET SPOT ‚úì</span>
        <span style="font-size:9px;color:var(--orange);font-family:var(--mono);">CAUTION</span>
        <span style="font-size:9px;color:var(--red);font-family:var(--mono);">EXIT SHORT CE ‚Üë</span>
      </div>
    </div>
  </div>

  <!-- CALENDAR + MINI POSITIONS -->
  <div class="g12 mb12">
    <div class="card">
      <div class="stitle">THETA DECAY CALENDAR</div>
      <div class="cal-wrap" id="cal-wrap"></div>
      <div id="cal-summary" class="alert-box info" style="font-size:10px;"></div>
    </div>
    <div class="card card-green">
      <div class="stitle">ACTIVE POSITIONS</div>
      <table class="tbl" id="d-positions-mini">
        <thead><tr><th>INSTRUMENT</th><th>TYPE</th><th>B/S</th><th>QTY</th><th>BS DELTA</th><th>P&L ‚Çπ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- CLIENT TABLE -->
  <div class="card mb12">
    <div class="stitle">CLIENT PORTFOLIO ‚Äî INCOME STATUS</div>
    <table class="tbl" id="d-client-tbl">
      <thead><tr><th>CLIENT</th><th>AUM</th><th>STRATEGY</th><th>LOTS</th><th>CREDIT ‚Çπ</th><th>TARGET LOW ‚Çπ</th><th>TARGET HIGH ‚Çπ</th><th>% OF AUM</th><th>STATUS</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POSITIONS -->
<div id="page-portfolio" class="page">
  <div class="card mb12" style="border-color:var(--accent2);">
    <div class="stitle">OPTIONS & FUTURES POSITIONS</div>
    <div class="btn-row mb12">
      <button class="btn btn-primary" onclick="openModal('opt')">+ ADD POSITION</button>
      <button class="btn btn-ghost" onclick="clearAllPositions()">‚úï CLEAR ALL</button>
      <button class="btn btn-green" style="padding:5px 10px;font-size:9px;" onclick="fetchLivePrices()">‚ü≥ REFRESH GREEKS</button>
      <div id="greeks-live-status" style="font-family:var(--mono);font-size:9px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <span style="color:var(--text3);">Greeks use ‚Üí</span>
        <span id="greeks-spot-badge" class="badge badge-blue">SPOT: ‚Äî</span>
        <span id="greeks-iv-badge" class="badge badge-orange">IV: ‚Äî</span>
        <span id="greeks-dte-badge" class="badge badge-gray">DTE: auto</span>
      </div>
    </div>
    <div style="overflow-x:auto;">
    <table class="tbl" id="opt-tbl">
      <thead><tr><th>#</th><th>INST</th><th>TYPE</th><th>B/S</th><th>ENTRY SPOT</th><th>STRIKE</th><th title="‚ö° Using live VIX when VIX mode ON. Entry IV shown when OFF.">IV% ‚ö°</th><th title="Auto-calculated daily from expiry date. No manual update needed.">DTE üóì</th><th>LOT</th><th>LOTS</th><th>NET QTY</th><th>TRADE PRICE ‚Çπ</th><th>CURR LTP ‚Çπ</th><th title="Recalculates every 1min (market hours) using live Nifty spot + VIX">BS DELTA ‚Üª</th><th>BS GAMMA</th><th>BS THETA/DAY</th><th>BS VEGA</th><th>P&L ‚Çπ</th><th>NOTES</th><th>ACT</th></tr></thead>
      <tbody id="opt-body"></tbody>
      <tfoot><tr class="total-row" id="opt-total"><td colspan="17" style="text-align:right;">PORTFOLIO TOTALS ‚Üí</td><td id="opt-total-pnl">‚Äî</td><td></td><td></td></tr></tfoot>
    </table>
    </div>
  </div>
  <div class="g4 mb12">
    <div class="card card-accent"><div class="kpi-label">Net BS Delta</div><div class="kpi-val kpi-sm accent" id="p-delta">‚Äî</div><div class="greek-explain">Full BS delta. Changes with spot, time, vol.</div></div>
    <div class="card card-green"><div class="kpi-label">Net Theta / Day ‚Çπ</div><div class="kpi-val kpi-sm green" id="p-theta">‚Äî</div><div class="greek-explain">Daily time decay. Accelerates near expiry.</div></div>
    <div class="card card-red"><div class="kpi-label">Net Gamma</div><div class="kpi-val kpi-sm red" id="p-gamma">‚Äî</div><div class="greek-explain">Negative gamma = losses accelerate on big moves.</div></div>
    <div class="card card-purple"><div class="kpi-label">Net Vega / 1% IV ‚Çπ</div><div class="kpi-val kpi-sm purple" id="p-vega">‚Äî</div><div class="greek-explain">VIX spike of 1% = this ‚Çπ impact on portfolio.</div></div>
  </div>

  <!-- POSITION SIZING CALCULATOR -->
  <div class="card card-orange mb12">
    <div class="stitle">‚öñ POSITION SIZING CALCULATOR</div>
    <div class="g2">
      <div>
        <div class="g2 mb8">
          <div class="inp-group">
            <label>TOTAL CAPITAL ‚Çπ</label>
            <input id="ps-capital" type="number" step="100000" placeholder="5000000">
            <div class="inp-hint">Your total deployable capital</div>
          </div>
          <div class="inp-group">
            <label>MAX RISK % OF CAPITAL</label>
            <input id="ps-risk-pct" type="number" step="0.5" value="2" placeholder="2">
            <div class="inp-hint">Max loss you accept as % of capital</div>
          </div>
          <div class="inp-group">
            <label>NIFTY MOVE SCENARIO %</label>
            <input id="ps-move" type="number" step="0.5" value="5" placeholder="5">
            <div class="inp-hint">Adverse move to stress-test (e.g. 5 = 5% down)</div>
          </div>
          <div class="inp-group">
            <label>OPTION PREMIUM ‚Çπ (per lot)</label>
            <input id="ps-premium" type="number" step="10" placeholder="185">
            <div class="inp-hint">Current premium received/paid per lot</div>
          </div>
          <div class="inp-group">
            <label>MARGIN PER LOT ‚Çπ</label>
            <input id="ps-margin" type="number" step="1000" placeholder="85000">
            <div class="inp-hint">SPAN + Exposure margin per lot</div>
          </div>
          <div class="inp-group">
            <label>LOT SIZE</label>
            <input id="ps-lotsize" type="number" value="65" placeholder="65">
            <div class="inp-hint">Nifty lot size</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="calcPositionSizing()">‚öñ CALCULATE</button>
          <button class="btn btn-ghost" onclick="resetPositionSizing()">RESET</button>
        </div>
      </div>
      <div id="ps-results" style="display:none;">
        <div class="stitle">RESULTS</div>
        <div id="ps-results-content"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EQUITY -->
<div id="page-equity" class="page">
  <div class="card mb12" style="border-color:var(--green2);">
    <div class="stitle">EQUITY STOCKS BOOK</div>
    <div class="btn-row mb12">
      <button class="btn btn-green" onclick="openModal('eq')">+ ADD STOCK</button>
      <button class="btn btn-ghost" onclick="clearAllEquity()">‚úï CLEAR ALL</button>
      <button class="btn btn-orange" onclick="fetchLivePrices()">‚ü≥ REFRESH CMPs</button>
    </div>
    <div style="overflow-x:auto;">
    <table class="tbl" id="eq-tbl">
      <thead><tr><th>#</th><th>STOCK</th><th>EXCH</th><th>L/S</th><th>QTY</th><th>AVG COST ‚Çπ</th><th>CMP ‚Çπ</th><th>BETA</th><th>INVESTED ‚Çπ</th><th>CURR VALUE ‚Çπ</th><th>P&L ‚Çπ</th><th>P&L%</th><th>DELTA ‚Çπ</th><th>BETA-ADJ ‚Çπ</th><th>SECTOR</th><th>ACT</th></tr></thead>
      <tbody id="eq-body"></tbody>
      <tfoot><tr class="total-row"><td colspan="8">EQUITY TOTALS</td><td id="eq-t-inv">‚Äî</td><td id="eq-t-curr">‚Äî</td><td id="eq-t-pnl">‚Äî</td><td id="eq-t-pnlpct">‚Äî</td><td id="eq-t-delta">‚Äî</td><td id="eq-t-betadelta">‚Äî</td><td></td><td></td></tr></tfoot>
    </table>
    </div>
  </div>
  <div class="g4">
    <div class="card card-green"><div class="kpi-label">Total Invested ‚Çπ</div><div class="kpi-val kpi-sm" id="e-inv">‚Äî</div></div>
    <div class="card card-accent"><div class="kpi-label">Current Value ‚Çπ</div><div class="kpi-val kpi-sm accent" id="e-curr">‚Äî</div></div>
    <div class="card card-green"><div class="kpi-label">Unrealised P&L ‚Çπ</div><div class="kpi-val kpi-sm" id="e-pnl">‚Äî</div></div>
    <div class="card card-purple"><div class="kpi-label">Beta-Adj Delta ‚Çπ</div><div class="kpi-val kpi-sm purple" id="e-beta">‚Äî</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCENARIO -->
<div id="page-scenario" class="page">
  <div class="card mb12">
    <div class="stitle">SCENARIO P&L ‚Äî FULL BLACK-SCHOLES AT EACH SPOT LEVEL</div>
    <p style="font-size:10px;color:var(--text3);margin-bottom:12px;">P&L = BS price at scenario spot ‚àí Entry BS price √ó Net Qty. Uses live VIX as IV (when VIX mode ON) and auto-calculated DTE from expiry date. Gamma curvature fully captured ‚Äî not a linear approximation.</p>
    <div style="overflow-x:auto;"><table class="scen-tbl" id="scen-tbl"></table></div>
  </div>
  <div class="card">
    <div class="stitle">DYNAMIC GREEKS AT EACH SCENARIO SPOT ‚Äî DELTA CHANGES WITH MARKET</div>
    <p style="font-size:10px;color:var(--text3);margin-bottom:12px;">This shows exactly how your delta, gamma, theta and vega shift as Nifty moves. Each column is fully recalculated at that spot price via Black-Scholes ‚Äî not interpolated. This is why delta changes and is not the same across columns.</p>
    <div style="overflow-x:auto;"><table class="scen-tbl" id="scen-greeks-tbl"></table></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GREEKS DEEP DIVE -->
<div id="page-greeks" class="page">
  <div class="card mb12" style="border-color:var(--purple);">
    <div class="stitle">WHY DELTA IS DIFFERENT AT EACH SPOT ‚Äî THE GAMMA EFFECT</div>
    <div class="g2">
      <div>
        <p style="font-size:11px;color:var(--text2);line-height:1.8;margin-bottom:10px;">
          <strong style="color:var(--accent);">What was fixed (v3.1):</strong> The previous normCDF (cumulative normal distribution) had a broken polynomial approximation ‚Äî it returned 0 for normCDF(0) instead of 0.5, making every Greek wrong. Now using the validated Abramowitz &amp; Stegun 7.1.26 formula, accurate to &lt;1.5e-7.
        </p>
        <p style="font-size:11px;color:var(--text2);line-height:1.8;margin-bottom:10px;">
          <strong style="color:var(--green);">How delta moves correctly now:</strong> Your portfolio has a dominant <em>long future</em> (+130 delta). Long put positions have <em>negative signed delta</em> which becomes <strong>more negative</strong> as spot falls (put goes ITM). This reduces net portfolio delta on downmoves ‚Äî your puts are hedging the future. At ‚àí5%, net delta falls from ~73 to ~32. At ‚àí10%, it falls to near zero. The puts are working.
        </p>
        <p style="font-size:11px;color:var(--text2);line-height:1.8;">
          <strong style="color:var(--orange);">Why Delta Exposure ‚Çπ can still look large on downmoves:</strong> Delta Exposure = NetDelta √ó ScenarioSpot. Even as NetDelta falls, if you look at the absolute ‚Çπ figure, a lower delta √ó lower spot can still show a mid-range number. The signed Delta Change row (green = delta falling = puts hedging) is the clearest indicator of hedge effectiveness.
        </p>
      </div>
      <div id="greeks-live-table"></div>
    </div>
  </div>
  <div class="stitle">PER-POSITION GREEKS AT CURRENT SPOT</div>
  <div style="overflow-x:auto;margin-bottom:12px;">
    <table class="tbl" id="greeks-full-tbl">
      <thead><tr><th>#</th><th>INSTRUMENT</th><th>TYPE</th><th>B/S</th><th>NET QTY</th><th>ENTRY SPOT</th><th>STRIKE</th><th>IV%</th><th>DTE</th><th>BS PRICE ‚Çπ</th><th>BS DELTA (unit)</th><th>NET DELTA</th><th>GAMMA</th><th>NET GAMMA</th><th>THETA/DAY</th><th>VEGA/1%IV</th></tr></thead>
      <tbody id="greeks-body"></tbody>
      <tfoot><tr class="total-row"><td colspan="11">TOTALS</td><td id="g-net-delta">‚Äî</td><td></td><td id="g-net-gamma">‚Äî</td><td id="g-net-theta">‚Äî</td><td id="g-net-vega">‚Äî</td></tr></tfoot>
    </table>
  </div>
  <div class="stitle">DELTA SENSITIVITY ‚Äî HOW FAST DELTA CHANGES WITH SPOT</div>
  <div style="overflow-x:auto;">
    <table class="scen-tbl" id="delta-scen-tbl"></table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ALERTS -->
<div id="page-alerts" class="page">
  <div class="g2 mb12">
    <div><div class="stitle">LIVE ALERT STATUS</div><div id="alert-list"></div></div>
    <div><div class="stitle">CRITICAL PRICE LEVELS</div><div id="level-list"></div></div>
  </div>
  <div class="stitle">NON-NEGOTIABLE RULES</div>
  <div id="rules-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS -->
<div id="page-settings" class="page">
  <div class="g2 mb12">
    <div class="card card-accent">
      <div class="stitle">MARKET DATA</div>
      <div class="g2 mb12">
        <div class="inp-group"><label>NIFTY SPOT</label><input type="number" id="s-nifty" step="5"><div class="inp-hint">Update manually or use FETCH LIVE button</div></div>
        <div class="inp-group"><label>INDIA VIX</label><input type="number" id="s-vix" step="0.1"></div>
        <div class="inp-group"><label>DAYS TO EXPIRY</label><input type="number" id="s-dte" step="1"></div>
        <div class="inp-group"><label>TOTAL NET CREDIT ‚Çπ</label><input type="number" id="s-credit" step="100"></div>
        <div class="inp-group"><label>RISK-FREE RATE %</label><input type="number" id="s-rfr" step="0.1" value="6.5"><div class="inp-hint">Used in Black-Scholes (RBI repo rate)</div></div>
        <div class="inp-group"><label>DEFAULT IV % (fallback)</label><input type="number" id="s-div" step="0.1" value="12.6"><div class="inp-hint">Used only when VIX mode OFF and position IV is blank</div></div>
        <div class="inp-group"><label>DEFAULT EXPIRY DATE</label><input type="date" id="s-default-expiry"><div class="inp-hint">Applied to new positions. NSE March 2026 expiry: 2026-03-26 (last Thursday)</div></div>
        <div class="inp-group" style="grid-column:span 2;">
          <label>IV SOURCE FOR LIVE GREEKS</label>
          <div style="display:flex;align-items:center;gap:14px;margin-top:6px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-family:var(--mono);font-size:11px;">
              <input type="checkbox" id="s-use-vix" style="width:16px;height:16px;accent-color:var(--orange);" onchange="APP.settings.useLiveVix=this.checked;saveState();renderAll();">
              <span>Use India VIX as live IV for all positions</span>
            </label>
            <span style="font-size:10px;color:var(--text3);">VIX <span style="color:var(--orange);">&#9889;</span> = India 30-day Nifty ATM IV. Updates every 1min with Fetch Live.</span>
          </div>
          <div class="inp-hint" style="margin-top:4px;">When ON: all delta/gamma/theta/vega recalculate with live VIX automatically. When OFF: uses stored entry IV per position.</div>
        </div>
      </div>
      <div class="stitle">SPREAD STRIKES</div>
      <div class="g2 mb12">
        <div class="inp-group"><label>SHORT PE STRIKE</label><input type="number" id="s-short-pe" step="50"></div>
        <div class="inp-group"><label>LONG PE STRIKE (hedge)</label><input type="number" id="s-long-pe" step="50"></div>
        <div class="inp-group"><label>SHORT CE STRIKE</label><input type="number" id="s-short-ce" step="50"></div>
        <div class="inp-group"><label>LONG CE STRIKE (hedge)</label><input type="number" id="s-long-ce" step="50"></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveSettings()">SAVE & REFRESH</button>
        <button class="btn btn-ghost" onclick="loadDefaults()">RESET TO DEFAULTS</button>
      </div>
    </div>

    <div class="card card-green">
      <div class="stitle">LIVE PRICE FETCH ‚Äî SYMBOLS</div>
      <div class="alert-box info mb12">
        <strong>How it works:</strong> We use Stooq (a free financial data source) via a CORS proxy to fetch live prices. Nifty50 = ^NF500 on Stooq. NSE stocks = SYMBOL.NS. The proxy may occasionally be blocked ‚Äî in that case use manual input.<br><br>
        <strong>Market hours:</strong> NSE trades 9:15 AM ‚Äì 3:30 PM IST Mon‚ÄìFri. Prices outside these hours will show previous close.
      </div>
      <div id="symbol-cfg">
        <div class="g2 mb8">
          <div class="inp-group"><label>NIFTY SYMBOL</label><input id="sym-nifty" value="^NSEI" readonly><div class="inp-hint">Yahoo Finance: ^NSEI</div></div>
          <div class="inp-group"><label>VIX SYMBOL</label><input id="sym-vix" value="^INDIAVIX" readonly><div class="inp-hint">Yahoo Finance: ^INDIAVIX</div></div>
        </div>
        <div class="stitle">EQUITY SYMBOLS (Yahoo Finance format)</div>
        <div id="eq-symbols-list" style="margin-bottom:10px;"></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-green" onclick="fetchLivePrices()">‚ü≥ FETCH LIVE PRICES NOW</button>
        <button class="btn btn-ghost" onclick="toggleAutoRefresh()">AUTO REFRESH: <span id="auto-refresh-status">OFF</span></button>
      </div>
      <div id="fetch-log" style="margin-top:10px;font-family:var(--mono);font-size:9px;color:var(--text3);"></div>
    </div>
  </div>

  <div class="g2 mb12">
    <div class="card card-green">
      <div class="stitle">CLIENT CONFIGURATION</div>
      <table class="tbl" id="client-cfg-tbl">
        <thead><tr><th>CLIENT</th><th>AUM ‚Çπ</th><th>LOTS</th><th>STRUCTURE</th><th>TARGET LOW ‚Çπ</th><th>TARGET HIGH ‚Çπ</th></tr></thead>
        <tbody id="client-cfg-body"></tbody>
      </table>
    </div>
    <div class="card">
      <div class="stitle">DATA MANAGEMENT</div>
      <div class="btn-row mb8">
        <button class="btn btn-danger" onclick="if(confirm('Clear ALL data?'))clearAll()">‚ö† CLEAR ALL</button>
        <button class="btn btn-ghost" onclick="exportData()">‚Üì EXPORT JSON</button>
        <button class="btn btn-ghost" onclick="loadFromFile()">‚Üë IMPORT JSON</button>
        <input type="file" id="file-import" accept=".json" style="display:none" onchange="importData(event)">
      </div>
      <div id="storage-info" class="kpi-sub"></div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DAILY M2M PAGE -->
<div id="page-m2m" class="page">

  <!-- TOP KPI STRIP -->
  <div class="g4 mb12">
    <div class="card card-green">
      <div class="kpi-label">TODAY'S M2M ‚Çπ</div>
      <div class="kpi-val kpi-sm" id="m2m-today">‚Äî</div>
      <div class="kpi-sub" id="m2m-today-sub">Close-to-close ¬∑ all positions</div>
    </div>
    <div class="card card-accent">
      <div class="kpi-label">MONTH CUMULATIVE ‚Çπ</div>
      <div class="kpi-val kpi-sm" id="m2m-month">‚Äî</div>
      <div class="kpi-sub" id="m2m-month-sub">Running total this month</div>
    </div>
    <div class="card card-green">
      <div class="kpi-label">BEST DAY THIS MONTH</div>
      <div class="kpi-val kpi-xs green" id="m2m-best">‚Äî</div>
      <div class="kpi-sub" id="m2m-best-date">‚Äî</div>
    </div>
    <div class="card card-red">
      <div class="kpi-label">WORST DAY THIS MONTH</div>
      <div class="kpi-val kpi-xs red" id="m2m-worst">‚Äî</div>
      <div class="kpi-sub" id="m2m-worst-date">‚Äî</div>
    </div>
  </div>

  <div class="g2 mb12">
    <!-- Today per-position M2M -->
    <div class="card card-accent">
      <div class="stitle">TODAY'S M2M ‚Äî PER POSITION</div>
      <div class="alert-box info mb8" style="font-size:10px;">
        M2M = (Today's LTP ‚àí Yesterday's closing LTP) √ó Net Qty.<br>
        Snapshot taken automatically at <strong>3:30 PM IST</strong> daily. Update your LTPs before market close for accurate M2M.
      </div>
      <table class="tbl" id="m2m-pos-tbl">
        <thead><tr>
          <th>POSITION</th><th>PREV CLOSE ‚Çπ</th><th>CURR LTP ‚Çπ</th>
          <th>CHANGE ‚Çπ</th><th>NET QTY</th><th>M2M ‚Çπ</th>
        </tr></thead>
        <tbody id="m2m-pos-body"></tbody>
      </table>
    </div>

    <!-- Controls + snapshot info -->
    <div>
      <div class="card card-orange mb12">
        <div class="stitle">SNAPSHOT CONTROLS</div>
        <div class="alert-box info mb12" style="font-size:11px;line-height:1.8;">
          <strong>How it works:</strong><br>
          1. Auto-snapshot at <strong>3:30 PM IST</strong> saves today's LTPs as closing prices<br>
          2. Next day, M2M = current LTP ‚àí yesterday's snapshot<br>
          3. History stored in Firebase ‚Äî syncs across all devices<br>
          4. Display resets at <strong>9:15 AM IST</strong> each morning
        </div>
        <div class="btn-row mb8">
          <button class="btn btn-primary" onclick="takeM2MSnapshot('manual')">üì∏ TAKE SNAPSHOT NOW</button>
          <button class="btn btn-ghost" onclick="renderM2MPage()">‚Üª REFRESH</button>
        </div>
        <div id="m2m-snapshot-status" style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:8px;"></div>
        <div class="stitle mt8">LAST SNAPSHOT</div>
        <div id="m2m-last-snapshot" class="alert-box ok" style="font-size:11px;">No snapshot taken yet today.</div>
      </div>

      <div class="card" style="border-top:2px solid var(--purple);">
        <div class="stitle">THIS MONTH SUMMARY</div>
        <div style="display:grid;gap:6px;" id="m2m-month-summary"></div>
      </div>
    </div>
  </div>

  <!-- 30-day history -->
  <div class="card card-green">
    <div class="stitle">30-DAY M2M HISTORY</div>
    <div style="overflow-x:auto;">
      <table class="tbl" id="m2m-history-tbl">
        <thead><tr>
          <th>DATE</th><th>DAY</th><th>OPT/FUT M2M ‚Çπ</th>
          <th>EQUITY M2M ‚Çπ</th><th>TOTAL M2M ‚Çπ</th><th>POSITIONS</th><th>NOTE</th>
        </tr></thead>
        <tbody id="m2m-history-body"></tbody>
      </table>
    </div>
    <div class="btn-row mt8">
      <button class="btn btn-ghost" style="font-size:9px;" onclick="exportM2MHistory()">‚Üì EXPORT M2M CSV</button>
      <button class="btn btn-danger" style="font-size:9px;" onclick="clearM2MHistory()">‚úï CLEAR HISTORY</button>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNC SETUP PAGE -->
<div id="page-sync" class="page">
  <div class="g2 mb12">

    <!-- Step-by-step setup card -->
    <div class="card card-orange">
      <div class="stitle">‚òÅ FIREBASE SYNC SETUP ‚Äî ONE TIME</div>
      <div id="sync-status-bar" class="alert-box info mb12" style="font-family:var(--mono);font-size:11px;">
        <strong id="sync-status-title">STATUS: NOT CONFIGURED</strong><br>
        <span id="sync-status-msg">Follow the steps below to enable multi-device sync. Takes ~8 minutes.</span>
      </div>

      <div class="stitle">STEP 1 ‚Äî CREATE FIREBASE PROJECT</div>
      <div class="alert-box info mb12" style="font-size:11px;line-height:1.8;">
        1. Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent);">console.firebase.google.com</a><br>
        2. Click <strong>Add project</strong> ‚Üí name it <strong>risk-desk</strong> ‚Üí Continue<br>
        3. Disable Google Analytics (not needed) ‚Üí <strong>Create project</strong><br>
        4. Wait ~30 seconds for it to provision
      </div>

      <div class="stitle">STEP 2 ‚Äî ENABLE REALTIME DATABASE</div>
      <div class="alert-box info mb12" style="font-size:11px;line-height:1.8;">
        1. In left sidebar: <strong>Build ‚Üí Realtime Database</strong><br>
        2. Click <strong>Create Database</strong><br>
        3. Choose location: <strong>asia-south1 (Mumbai)</strong> ‚Üí Next<br>
        4. Select <strong>Start in test mode</strong> ‚Üí Enable<br>
        <span style="color:var(--orange);">‚ö† Test mode is fine ‚Äî your data is protected by the URL being private to you</span>
      </div>

      <div class="stitle">STEP 3 ‚Äî GET CONFIG VALUES</div>
      <div class="alert-box info mb12" style="font-size:11px;line-height:1.8;">
        1. Click gear icon ‚öô ‚Üí <strong>Project settings</strong><br>
        2. Scroll to <strong>Your apps</strong> ‚Üí Click <strong>&lt;/&gt; Web</strong><br>
        3. App nickname: <strong>risk-desk-web</strong> ‚Üí Register app<br>
        4. You'll see a <code>firebaseConfig</code> object ‚Äî copy the 5 values below
      </div>

      <div class="stitle">STEP 4 ‚Äî PASTE CONFIG HERE</div>
      <div class="g2 mb12">
        <div class="inp-group"><label>API KEY</label><input id="fb-api-key" placeholder="AIzaSy..."><div class="inp-hint">firebaseConfig.apiKey</div></div>
        <div class="inp-group"><label>PROJECT ID</label><input id="fb-project-id" placeholder="risk-desk-xxxxx"><div class="inp-hint">firebaseConfig.projectId</div></div>
        <div class="inp-group"><label>DATABASE URL</label><input id="fb-db-url" placeholder="https://risk-desk-xxxxx-default-rtdb.asia-southeast1.firebasedatabase.app"><div class="inp-hint">firebaseConfig.databaseURL</div></div>
        <div class="inp-group"><label>APP ID</label><input id="fb-app-id" placeholder="1:123456789:web:abc..."><div class="inp-hint">firebaseConfig.appId</div></div>
        <div class="inp-group"><label>MESSAGING SENDER ID</label><input id="fb-sender-id" placeholder="123456789"><div class="inp-hint">firebaseConfig.messagingSenderId</div></div>
        <div class="inp-group"><label>AUTH DOMAIN</label><input id="fb-auth-domain" placeholder="risk-desk-xxxxx.firebaseapp.com"><div class="inp-hint">firebaseConfig.authDomain</div></div>
      </div>
      <div class="btn-row mb12">
        <button class="btn btn-primary" onclick="saveFirebaseConfig()">SAVE & CONNECT</button>
        <button class="btn btn-ghost" onclick="testFirebaseConnection()">TEST CONNECTION</button>
        <button class="btn btn-danger" onclick="clearFirebaseConfig()">CLEAR CONFIG</button>
      </div>
      <div id="fb-connect-log" style="font-family:var(--mono);font-size:9px;color:var(--text3);min-height:20px;"></div>
    </div>

    <!-- Status + GitHub deploy card -->
    <div>
      <div class="card card-green mb12">
        <div class="stitle">SYNC STATUS</div>
        <div style="display:grid;gap:8px;">
          <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg3);border:1px solid var(--border);">
            <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">FIREBASE</span>
            <span id="fb-status-badge" class="badge badge-gray">NOT CONFIGURED</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg3);border:1px solid var(--border);">
            <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">LAST SYNC</span>
            <span id="fb-last-sync" style="font-family:var(--mono);font-size:10px;color:var(--text2);">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg3);border:1px solid var(--border);">
            <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">MODE</span>
            <span id="fb-mode-badge" class="badge badge-gray">LOCAL ONLY</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg3);border:1px solid var(--border);">
            <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">RECORDS</span>
            <span id="fb-records-count" style="font-family:var(--mono);font-size:10px;color:var(--text2);">‚Äî</span>
          </div>
        </div>
        <div class="btn-row mt8">
          <button class="btn btn-green" onclick="forceSyncToFirebase()" style="font-size:9px;">‚Üë PUSH TO CLOUD</button>
          <button class="btn btn-ghost" onclick="forceSyncFromFirebase()" style="font-size:9px;">‚Üì PULL FROM CLOUD</button>
        </div>
      </div>

      <div class="card card-accent">
        <div class="stitle">STEP 5 ‚Äî DEPLOY TO GITHUB PAGES</div>
        <div class="alert-box info mb8" style="font-size:11px;line-height:1.8;">
          1. Go to <a href="https://github.com" target="_blank" style="color:var(--accent);">github.com</a> ‚Üí Sign up (free)<br>
          2. Click <strong>+</strong> ‚Üí New repository ‚Üí name: <strong>risk-desk</strong><br>
          3. Set to <strong>Public</strong> ‚Üí Create repository<br>
          4. Click <strong>uploading an existing file</strong><br>
          5. <strong>Download this file</strong> (button below) ‚Üí drag it into GitHub ‚Üí Commit<br>
          6. Go to Settings ‚Üí Pages ‚Üí Source: <strong>main branch</strong> ‚Üí Save<br>
          7. Your app URL: <code style="color:var(--accent);">https://YOUR-USERNAME.github.io/risk-desk</code>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="downloadConfiguredFile()" style="font-size:9px;">‚Üì DOWNLOAD CONFIGURED FILE</button>
        </div>
        <div class="alert-box warning mt8" style="font-size:10px;">
          <strong>Important:</strong> Download AFTER saving Firebase config above. The downloaded file will have your config baked in ‚Äî ready to upload to GitHub.
        </div>
      </div>

      <div class="card mt8" style="border-top:2px solid var(--purple);">
        <div class="stitle">INSTALL AS APP (AFTER GITHUB DEPLOY)</div>
        <div style="font-size:11px;line-height:1.8;color:var(--text2);">
          <strong style="color:var(--text);">Android Chrome:</strong><br>
          Open your GitHub Pages URL ‚Üí tap ‚ãÆ menu ‚Üí <strong>Add to Home screen</strong><br><br>
          <strong style="color:var(--text);">Windows Chrome/Edge:</strong><br>
          Open URL ‚Üí click install icon in address bar (or ‚ãÆ ‚Üí Install RISK DESK)<br><br>
          <strong style="color:var(--text);">iPhone Safari:</strong><br>
          Open URL ‚Üí tap Share ‚Üí <strong>Add to Home Screen</strong>
        </div>
      </div>
    </div>

  </div>
</div>

</div><!-- end wrap -->

<!-- MODALS -->
<div class="modal-bg" id="modal-opt">
  <div class="modal">
    <h3 id="modal-title-opt">ADD NEW OPTION OR FUTURE</h3>
    <input type="hidden" id="opt-edit-idx">
    <div class="modal-grid">
      <div class="inp-group"><label>INSTRUMENT</label><input id="f-inst" value="NIFTY"></div>
      <div class="inp-group"><label>TYPE</label><select id="f-type"><option>Call</option><option>Put</option><option>Future</option></select></div>
      <div class="inp-group"><label>BUY / SELL</label><select id="f-bs"><option>Buy</option><option>Sell</option></select></div>
      <div class="inp-group"><label>ENTRY SPOT ‚Çπ</label><input id="f-spot" type="number" step="5"></div>
      <div class="inp-group"><label>STRIKE ‚Çπ (options)</label><input id="f-strike" type="number" step="50"></div>
      <div class="inp-group"><label>ENTRY IV %</label><input id="f-iv" type="number" step="0.1" placeholder="12.6"></div>
      <div class="inp-group"><label>DTE AT ENTRY</label><input id="f-dte" type="number" step="1"></div>
      <div class="inp-group"><label>EXPIRY DATE</label><input id="f-expiry" type="date"><div class="inp-hint">DTE auto-calculated daily from this date</div></div>
      <div class="inp-group"><label>LOT SIZE</label><input id="f-lotsize" type="number" value="75"></div>
      <div class="inp-group"><label>NUMBER OF LOTS</label><input id="f-lots" type="number" value="1"></div>
      <div class="inp-group"><label>TRADE PRICE ‚Çπ (actual)</label><input id="f-tradeprice" type="number" step="0.05"></div>
      <div class="inp-group"><label>CURRENT LTP ‚Çπ</label><input id="f-ltp" type="number" step="0.05"></div>
      <div class="inp-group" style="grid-column:span 2;"><label>NOTES</label><input id="f-notes"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="savePosition()">SAVE</button>
      <button class="btn btn-ghost" onclick="closeModal('opt')">CANCEL</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-eq">
  <div class="modal">
    <h3 id="modal-title-eq">ADD NEW EQUITY POSITION</h3>
    <input type="hidden" id="eq-edit-idx">
    <div class="modal-grid">
      <div class="inp-group"><label>STOCK SYMBOL</label><input id="ef-stock"></div>
      <div class="inp-group"><label>YAHOO SYMBOL (for live price)</label><input id="ef-yahoo" placeholder="NIFTYBEES.NS"><div class="inp-hint">Used for live price fetch. Leave blank to skip.</div></div>
      <div class="inp-group"><label>EXCHANGE</label><select id="ef-exch"><option>NSE</option><option>BSE</option></select></div>
      <div class="inp-group"><label>LONG / SHORT</label><select id="ef-dir"><option>Long</option><option>Short</option></select></div>
      <div class="inp-group"><label>QUANTITY</label><input id="ef-qty" type="number"></div>
      <div class="inp-group"><label>AVG COST ‚Çπ</label><input id="ef-cost" type="number" step="0.01"></div>
      <div class="inp-group"><label>CMP ‚Çπ (live)</label><input id="ef-cmp" type="number" step="0.01"></div>
      <div class="inp-group"><label>BETA</label><input id="ef-beta" type="number" step="0.01" value="1"></div>
      <div class="inp-group"><label>SECTOR</label><input id="ef-sector"></div>
      <div class="inp-group"><label>NOTES</label><input id="ef-notes"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-green" onclick="saveEquity()">SAVE</button>
      <button class="btn btn-ghost" onclick="closeModal('eq')">CANCEL</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BLACK-SCHOLES ENGINE ‚Äî FULL IMPLEMENTATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Standard normal CDF ‚Äî Abramowitz & Stegun 7.1.26, max error < 1.5e-7
// Verified: normCDF(0)=0.5, normCDF(1)=0.8413, normCDF(-1)=0.1587, normCDF(2)=0.9772
function normCDF(x) {
  const sign = x < 0 ? -1 : 1;
  const z = Math.abs(x) / Math.SQRT2;
  const t = 1 / (1 + 0.3275911 * z);
  const erfc = t * (0.254829592 + t * (-0.284496736 + t * (1.421413741 + t * (-1.453152027 + t * 1.061405429)))) * Math.exp(-z * z);
  return 0.5 * (1 + sign * (1 - erfc));
}

function normPDF(x) {
  return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

// Full Black-Scholes: returns {price, delta, gamma, theta, vega}
// S = spot, K = strike, r = risk-free (decimal), sigma = IV (decimal), T = time in years
// type = 'Call' or 'Put', dir = 1 (long) or -1 (short), qty = absolute units
function bs(S, K, r, sigma, T, type, dir, qty) {
  if (T <= 0) T = 1/365;
  const sqrtT = Math.sqrt(T);
  const d1 = (Math.log(S/K) + (r + 0.5*sigma*sigma)*T) / (sigma*sqrtT);
  const d2 = d1 - sigma*sqrtT;

  let price, deltaUnit, gammaUnit, thetaUnit, vegaUnit;

  if (type === 'Call') {
    price      = S*normCDF(d1) - K*Math.exp(-r*T)*normCDF(d2);
    deltaUnit  = normCDF(d1);
    gammaUnit  = normPDF(d1) / (S*sigma*sqrtT);
    thetaUnit  = -(S*normPDF(d1)*sigma)/(2*sqrtT) - r*K*Math.exp(-r*T)*normCDF(d2);
    vegaUnit   = S*normPDF(d1)*sqrtT;
  } else {
    price      = K*Math.exp(-r*T)*normCDF(-d2) - S*normCDF(-d1);
    deltaUnit  = normCDF(d1) - 1;
    gammaUnit  = normPDF(d1) / (S*sigma*sqrtT);
    thetaUnit  = -(S*normPDF(d1)*sigma)/(2*sqrtT) + r*K*Math.exp(-r*T)*normCDF(-d2);
    vegaUnit   = S*normPDF(d1)*sqrtT;
  }

  // Scale to net position: delta/gamma in units, theta/vega in ‚Çπ
  const netDelta = deltaUnit * qty * dir;        // signed delta units
  const netGamma = gammaUnit * qty * dir;        // signed gamma
  const netTheta = (thetaUnit/365) * qty * dir;  // ‚Çπ/day
  const netVega  = (vegaUnit/100)  * qty * dir;  // ‚Çπ per 1% IV move

  return { price, deltaUnit, netDelta, netGamma, netTheta, netVega, d1, d2 };
}

// DTE HELPER: auto-calc from expiry date so DTE decrements daily automatically
// Expiry stored as 'YYYY-MM-DD'. NSE market closes at 15:30 IST = 10:00 UTC.
function calcDTE(pos) {
  if (pos.expiry) {
    const expClose = new Date(pos.expiry + 'T10:00:00Z').getTime();
    const days = (expClose - Date.now()) / 86400000;
    return Math.max(1 / 365, days);
  }
  return (pos.dteCurr !== undefined ? pos.dteCurr : (pos.dte || APP.settings.dte || 30));
}

// IV HELPER: use India VIX as live IV proxy when useLiveVix=true.
// India VIX IS the 30-day Nifty ATM implied volatility annualised --
// so VIX/100 is the exact sigma input for Nifty option BS calculation.
// This means every 1-min Fetch Live updates all deltas/greeks automatically.
function calcIV(pos) {
  if (APP.settings.useLiveVix && APP.settings.vix > 0) return APP.settings.vix / 100;
  return (pos.iv || APP.settings.defIV || 12.6) / 100;
}

// MAIN BS CALCULATOR
// spotOverride: scenario table passes different spots. Otherwise uses live Nifty.
function calcBS(pos, spotOverride) {
  const S = (spotOverride !== undefined && spotOverride !== null)
            ? spotOverride : (APP.settings.nifty || pos.spot || 25725);
  const K = pos.strike;
  const r = (APP.settings.rfr || 6.5) / 100;
  const sigma = calcIV(pos);
  const T = calcDTE(pos) / 365;
  const dir = pos.bs === 'Buy' ? 1 : -1;
  const qty = pos.lotSize * pos.lots;

  if (pos.type === 'Future') {
    const netDelta = qty * dir;
    return { price: S, deltaUnit: 1, netDelta, netGamma: 0, netTheta: 0, netVega: 0 };
  }
  if (!K || !sigma || sigma <= 0) {
    return { price: 0, deltaUnit: 0, netDelta: 0, netGamma: 0, netTheta: 0, netVega: 0 };
  }

  return bs(S, K, r, sigma, T, pos.type, dir, qty);
}

// BS theoretical price at a given spot for scenario P&L
// Uses same calcIV + calcDTE as calcBS for consistency.
function bsPrice(pos, S) {
  const K = pos.strike;
  const r = (APP.settings.rfr || 6.5) / 100;
  const sigma = calcIV(pos);
  const T = calcDTE(pos) / 365;
  if (T <= 0 || !K || sigma <= 0) return 0;
  const sqrtT = Math.sqrt(T);
  const d1 = (Math.log(S/K) + (r + 0.5*sigma*sigma)*T) / (sigma*sqrtT);
  const d2 = d1 - sigma*sqrtT;
  if (pos.type === "Call") return S*normCDF(d1) - K*Math.exp(-r*T)*normCDF(d2);
  return K*Math.exp(-r*T)*normCDF(-d2) - S*normCDF(-d1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY = 'nifty_cmd_v3';

const DEFAULT_SETTINGS = {
  nifty:25725, vix:12.6, dte:40, credit:67250,
  shortPE:25200, longPE:24800, shortCE:26200, longCE:26500,
  rfr:6.5, defIV:12.6, useLiveVix:true, defaultExpiry:'2026-03-26'
};

const DEFAULT_POSITIONS = [
  { inst:'NIFTY', type:'Call', bs:'Sell', spot:25760, strike:25800, iv:12, dte:5, dteCurr:5, expiry:'2026-02-27', lotSize:65, lots:1, tradePrice:90, ltp:110, notes:'Weekly' },
  { inst:'NIFTY', type:'Call', bs:'Sell', spot:25760, strike:26000, iv:12, dte:5, dteCurr:5, expiry:'2026-02-27', lotSize:65, lots:1, tradePrice:54, ltp:38.5, notes:'Weekly' },
  { inst:'NIFTY', type:'Put',  bs:'Buy',  spot:25500, strike:25200, iv:12, dte:39, dteCurr:40, expiry:'2026-03-26', lotSize:65, lots:1, tradePrice:184.65, ltp:142, notes:'Monthly' },
  { inst:'NIFTY', type:'Put',  bs:'Buy',  spot:25500, strike:25000, iv:12, dte:39, dteCurr:40, expiry:'2026-03-26', lotSize:65, lots:1, tradePrice:145.98, ltp:110, notes:'Monthly' },
  { inst:'NIFTY', type:'Future', bs:'Buy', spot:25752, strike:null, iv:null, dte:5, dteCurr:5, expiry:'2026-02-27', lotSize:65, lots:2, tradePrice:25310.45, ltp:25710, notes:'Weekly' },
];

const DEFAULT_EQUITY = [
  { stock:'CPSEETF',   yahoo:'CPSEETF.NS',   exch:'NSE', dir:'Long', qty:1000, cost:93.04,  cmp:100.65, beta:1.05, sector:'INDEX', notes:'' },
  { stock:'NIFTYBEES', yahoo:'NIFTYBEES.NS',  exch:'NSE', dir:'Long', qty:7500, cost:286.42, cmp:291.61, beta:1,    sector:'INDEX', notes:'' },
  { stock:'INFRABEES', yahoo:'INFRABEES.NS',  exch:'NSE', dir:'Long', qty:100,  cost:925.51, cmp:998.02, beta:1,    sector:'INDEX', notes:'' },
  { stock:'MOREALTY',  yahoo:'MOIL.NS',       exch:'NSE', dir:'Long', qty:1750, cost:85.01,  cmp:83.32,  beta:1.8,  sector:'PSU Banks', notes:'' },
];

const DEFAULT_CLIENTS = [
  { id:'A', aum:5000000, lots:2, credit:25500, targetLo:70000,  targetHi:85000,  structure:'Iron Condor + Weekly' },
  { id:'B', aum:3600000, lots:2, credit:19500, targetLo:34500,  targetHi:42000,  structure:'Iron Condor' },
  { id:'C', aum:2000000, lots:2, credit:13500, targetLo:20700,  targetHi:23100,  structure:'Bull Put Spread' },
  { id:'D', aum:1650000, lots:2, credit:13500, targetLo:18900,  targetHi:20700,  structure:'Bull Put Spread' },
  { id:'E', aum:1200000, lots:1, credit:6750,  targetLo:10650,  targetHi:14000,  structure:'Single Bull Put' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG ‚Äî filled by user in Sync Setup page
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FB_CONFIG_KEY = 'risk_desk_firebase_cfg';
let fbDatabase = null;
let fbConnected = false;
let fbSyncing = false;
let fbLastSync = null;

function loadFirebaseConfig() {
  try { const r = localStorage.getItem(FB_CONFIG_KEY); return r ? JSON.parse(r) : null; } catch(e) { return null; }
}
function saveFirebaseConfig() { try {
  const cfg = {
    apiKey:            el('fb-api-key').value.trim(),
    projectId:         el('fb-project-id').value.trim(),
    databaseURL:       el('fb-db-url').value.trim(),
    appId:             el('fb-app-id').value.trim(),
    messagingSenderId: el('fb-sender-id').value.trim(),
    authDomain:        el('fb-auth-domain').value.trim(),
  };
  if (!cfg.apiKey || !cfg.databaseURL || !cfg.projectId) {
    toast('Fill in API Key, Project ID and Database URL at minimum', true);
    return;
  }
  localStorage.setItem(FB_CONFIG_KEY, JSON.stringify(cfg));
  toast('Firebase config saved ‚Äî connecting...');
  initFirebase(cfg);
  } catch(e) { toast('Error saving config: '+e.message, true); console.error(e); }
}
function clearFirebaseConfig() {
  if (!confirm('Remove Firebase config? App will work offline only.')) return;
  localStorage.removeItem(FB_CONFIG_KEY);
  fbDatabase = null; fbConnected = false;
  updateSyncUI();
  toast('Firebase config cleared');
}

async function initFirebase(cfg) {
  const log = el('fb-connect-log');
  if (log) log.textContent = '‚è≥ Loading Firebase SDK...';
  try {
    // Dynamically load Firebase SDK (CDN) ‚Äî avoids bundler, works in single HTML file
    await loadScript('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js');

    if (log) log.textContent = '‚è≥ Initialising Firebase app...';

    // Avoid re-initialising if already done
    if (firebase.apps.length === 0) {
      firebase.initializeApp(cfg);
    }
    fbDatabase = firebase.database();

    // Test connection with a lightweight read
    if (log) log.textContent = '‚è≥ Testing connection...';
    await fbDatabase.ref('.info/connected').once('value');

    fbConnected = true;
    if (log) log.textContent = '‚úì Connected to Firebase! Setting up real-time listener...';
    toast('Firebase connected ‚úì ‚Äî sync active');
    setupFirebaseListener();
    updateSyncUI();

    // Push current local data to Firebase on first connect if cloud is empty
    const snap = await fbDatabase.ref('riskdesk/app').once('value');
    if (!snap.exists()) {
      if (log) log.textContent += '\n‚è≥ Cloud empty ‚Äî pushing local data...';
      await fbDatabase.ref('riskdesk/app').set(APP);
      if (log) log.textContent += '\n‚úì Local data pushed to cloud.';
    }
  } catch(e) {
    fbConnected = false;
    const msg = '‚úó Firebase connection failed: ' + e.message;
    if (log) log.textContent = msg;
    toast('Firebase failed: ' + e.message, true);
    console.error('Firebase init error:', e);
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector('script[src="'+src+'"]')) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

function setupFirebaseListener() {
  if (!fbDatabase) return;
  // Real-time listener ‚Äî any change from another device triggers a local update
  fbDatabase.ref('riskdesk/app').on('value', snap => {
    const remote = snap.val();
    if (!remote || fbSyncing) return; // ignore if we triggered the write
    APP = remote;
    // Apply migration guards on received data
    if (!APP.clients) APP.clients = JSON.parse(JSON.stringify(DEFAULT_CLIENTS));
    if (!APP.settings.rfr) APP.settings.rfr = 6.5;
    if (!APP.settings.defIV) APP.settings.defIV = 12.6;
    if (APP.settings.useLiveVix === undefined) APP.settings.useLiveVix = true;
    if (!APP.settings.defaultExpiry) APP.settings.defaultExpiry = '2026-03-26';
    APP.positions.forEach(p => { if (!p.expiry) p.expiry = APP.settings.defaultExpiry; });
if (!APP.m2mHistory) APP.m2mHistory = [];
if (!APP.m2mSnapshots) APP.m2mSnapshots = {};
    // Save to localStorage as offline cache
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(APP)); } catch(e) {}
    fbLastSync = new Date();
    updateSyncUI();
    renderAll();
    loadSettingsForm();
  });
}

async function forceSyncToFirebase() {
  if (!fbDatabase) { toast('Firebase not connected', true); return; }
  try {
    fbSyncing = true;
    await fbDatabase.ref('riskdesk/app').set(APP);
    fbSyncing = false;
    fbLastSync = new Date();
    updateSyncUI();
    toast('Pushed to cloud ‚úì');
  } catch(e) { fbSyncing = false; toast('Push failed: '+e.message, true); }
}

async function forceSyncFromFirebase() {
  if (!fbDatabase) { toast('Firebase not connected', true); return; }
  try {
    const snap = await fbDatabase.ref('riskdesk/app').once('value');
    const remote = snap.val();
    if (!remote) { toast('Nothing in cloud yet', true); return; }
    APP = remote;
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(APP)); } catch(e) {}
    fbLastSync = new Date();
    updateSyncUI();
    renderAll();
    loadSettingsForm();
    toast('Pulled from cloud ‚úì');
  } catch(e) { toast('Pull failed: '+e.message, true); }
}

async function testFirebaseConnection() {
  const cfg = loadFirebaseConfig();
  if (!cfg) { toast('No config saved yet', true); return; }
  const log = el('fb-connect-log');
  if (log) log.textContent = '‚è≥ Testing...';
  await initFirebase(cfg);
}

function updateSyncUI() { try {
  const badge = el('fb-status-badge');
  const modeBadge = el('fb-mode-badge');
  const lastSync = el('fb-last-sync');
  const records = el('fb-records-count');
  const navSync = el('nav-sync');
  const statusTitle = el('sync-status-title');
  const statusMsg = el('sync-status-msg');

  if (fbConnected) {
    if (badge) { badge.textContent = 'CONNECTED ‚úì'; badge.className = 'badge badge-green'; }
    if (modeBadge) { modeBadge.textContent = 'CLOUD SYNC ON'; modeBadge.className = 'badge badge-green'; }
    if (navSync) { navSync.textContent = '‚òÅ SYNC ‚úì'; navSync.style.color = 'var(--green)'; }
    if (statusTitle) statusTitle.textContent = 'STATUS: CONNECTED ‚Äî SYNC ACTIVE';
    if (statusMsg) statusMsg.textContent = 'All changes sync to cloud in real-time. Open on any device to see live data.';
  } else {
    const cfgCheck = loadFirebaseConfig();
    if (badge) { badge.textContent = cfgCheck ? 'CONFIG SAVED' : 'NOT CONFIGURED'; badge.className = cfgCheck ? 'badge badge-orange' : 'badge badge-gray'; }
    if (modeBadge) { modeBadge.textContent = 'LOCAL ONLY'; modeBadge.className = 'badge badge-gray'; }
    if (navSync) { navSync.textContent = '‚òÅ SYNC SETUP'; navSync.style.color = 'var(--orange)'; }
  }
  if (lastSync && fbLastSync) lastSync.textContent = fbLastSync.toLocaleTimeString('en-IN', {hour12:false});
  if (records && APP) {
    records.textContent = (APP.positions?.length||0) + ' positions ¬∑ ' + (APP.equity?.length||0) + ' stocks';
  }
  // Load saved config into form if present
  const cfg2 = loadFirebaseConfig();
  if (cfg2) {
    const fields = {
      'fb-api-key': cfg2.apiKey, 'fb-project-id': cfg2.projectId,
      'fb-db-url': cfg2.databaseURL, 'fb-app-id': cfg2.appId,
      'fb-sender-id': cfg2.messagingSenderId, 'fb-auth-domain': cfg2.authDomain
    };
    Object.entries(fields).forEach(([id, val]) => { const e = el(id); if(e && val) e.value = val; });
  }
  } catch(e) { console.warn('updateSyncUI error:', e); }
}

function downloadConfiguredFile() {
  const cfg = loadFirebaseConfig() || FIREBASE_PRECONFIG;
  if (!cfg || !cfg.apiKey) {
    toast('Save Firebase config first!', true);
    return;
  }
  // Build a clean config script tag to inject
  const cfgScript = 'const FIREBASE_PRECONFIG = ' + JSON.stringify(cfg) + ';';
  // Get page source and replace the preconfig line
  const src = document.documentElement.outerHTML;
  // Replace whatever is currently in FIREBASE_PRECONFIG with the saved cfg
  const configured = src.replace(/const FIREBASE_PRECONFIG = .*?;/s, cfgScript);
  const blob = new Blob([configured], {type: 'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'risk-desk.html';
  a.click();
  toast('Downloaded risk-desk.html ‚Äî upload this to GitHub ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & STORAGE ‚Äî Firebase-aware
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Pre-baked config (filled when user downloads configured file)
const FIREBASE_PRECONFIG = {"apiKey":"AIzaSyBar6B4Tx0Jnl8bYzJ8DJafuZ4cVZag4iQ","authDomain":"risk-desk.firebaseapp.com","databaseURL":"https://risk-desk-default-rtdb.asia-southeast1.firebasedatabase.app","projectId":"risk-desk","storageBucket":"risk-desk.firebasestorage.app","messagingSenderId":"234434848357","appId":"1:234434848357:web:a7893733d3c5626d30888c"};

function loadState() {
  try { const r = localStorage.getItem(STORAGE_KEY); if(r) return JSON.parse(r); } catch(e){}
  return null;
}

function saveState() {
  // Always save to localStorage (offline cache + fallback)
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(APP)); updateStorageInfo(); } catch(e) {}
  // If Firebase connected, push to cloud too
  if (fbDatabase && fbConnected) {
    fbSyncing = true;
    fbDatabase.ref('riskdesk/app').set(APP)
      .then(() => { fbSyncing = false; fbLastSync = new Date(); updateSyncUI(); })
      .catch(e => { fbSyncing = false; console.warn('Firebase write failed:', e); });
  }
}

let saved = loadState();
let APP = saved || {
  settings: {...DEFAULT_SETTINGS},
  positions: JSON.parse(JSON.stringify(DEFAULT_POSITIONS)),
  equity:    JSON.parse(JSON.stringify(DEFAULT_EQUITY)),
  clients:   JSON.parse(JSON.stringify(DEFAULT_CLIENTS)),
};
if (!APP.clients) APP.clients = JSON.parse(JSON.stringify(DEFAULT_CLIENTS));
if (!APP.settings.rfr) APP.settings.rfr = 6.5;
if (!APP.settings.defIV) APP.settings.defIV = 12.6;
if (APP.settings.useLiveVix === undefined) APP.settings.useLiveVix = true;
if (!APP.settings.defaultExpiry) APP.settings.defaultExpiry = '2026-03-26';
APP.positions.forEach(p => { if (!p.expiry) p.expiry = APP.settings.defaultExpiry; });



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POSITION SIZING CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcPositionSizing() {
  const capital    = parseFloat(el('ps-capital').value) || 0;
  const riskPct    = parseFloat(el('ps-risk-pct').value) || 2;
  const movePct    = parseFloat(el('ps-move').value) || 5;
  const premium    = parseFloat(el('ps-premium').value) || 0;
  const margin     = parseFloat(el('ps-margin').value) || 0;
  const lotSize    = parseFloat(el('ps-lotsize').value) || 65;
  const nifty      = APP.settings.nifty || 25725;

  if (!capital) { toast('Enter total capital first', true); return; }

  const maxRiskRs     = capital * riskPct / 100;
  const niftyMove     = nifty * movePct / 100;         // ‚Çπ move in Nifty
  const lossPerLot    = niftyMove * lotSize;            // approx loss per lot on adverse move
  const maxLotsByRisk = lossPerLot > 0 ? Math.floor(maxRiskRs / lossPerLot) : 0;
  const maxLotsByMargin = margin > 0 ? Math.floor(capital * 0.5 / margin) : 0; // 50% margin util cap
  const recommendedLots = Math.min(maxLotsByRisk, maxLotsByMargin > 0 ? maxLotsByMargin : maxLotsByRisk);
  const totalMarginReqd = recommendedLots * margin;
  const marginUtilPct   = capital > 0 ? (totalMarginReqd / capital * 100) : 0;
  const premiumIncome   = recommendedLots * premium * lotSize;
  const premiumYield    = capital > 0 ? (premiumIncome / capital * 100) : 0;

  // Per-client allocation by AUM ratio
  const totalAUM = APP.clients.reduce((s, c) => s + (c.aum || 0), 0);
  const clientRows = APP.clients.map(c => {
    const ratio = totalAUM > 0 ? c.aum / totalAUM : 0;
    const clientLots = Math.max(1, Math.round(recommendedLots * ratio));
    const clientMargin = clientLots * margin;
    const clientMarginPct = c.aum > 0 ? (clientMargin / c.aum * 100) : 0;
    const clientPremium = clientLots * premium * lotSize;
    return { ...c, clientLots, clientMargin, clientMarginPct, clientPremium };
  });

  // Render results
  const resultsEl = el('ps-results');
  const contentEl = el('ps-results-content');
  resultsEl.style.display = 'block';

  contentEl.innerHTML = `
    <div style="display:grid;gap:6px;margin-bottom:12px;">
      ${[
        {label:'Max Risk ‚Çπ', val:'‚Çπ'+fmt(maxRiskRs), color:'var(--orange)', hint:'Capital √ó Risk%'},
        {label:'Loss per Lot', val:'‚Çπ'+fmt(lossPerLot), color:'var(--red)', hint:'Nifty move √ó Lot size'},
        {label:'Max Lots (Risk)', val:maxLotsByRisk, color:'var(--accent)', hint:'Max risk √∑ loss per lot'},
        {label:'Max Lots (Margin)', val:maxLotsByMargin||'‚Äî', color:'var(--text2)', hint:'50% margin utilisation cap'},
        {label:'‚úÖ RECOMMENDED LOTS', val:recommendedLots, color:'var(--green)', hint:'Lower of risk & margin limit'},
        {label:'Margin Required', val:'‚Çπ'+fmt(totalMarginReqd), color:'var(--text)', hint:'Total SPAN+Exposure'},
        {label:'Margin Utilisation', val:marginUtilPct.toFixed(1)+'%', color:marginUtilPct>60?'var(--red)':'var(--green)', hint:'of total capital'},
        {label:'Premium Income', val:'‚Çπ'+fmt(premiumIncome), color:'var(--green)', hint:'If selling options'},
        {label:'Premium Yield', val:premiumYield.toFixed(2)+'%', color:'var(--green)', hint:'of capital'},
      ].map(r=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 8px;background:var(--bg3);border:1px solid var(--border);">
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);">${r.label}</div>
          <div style="font-size:9px;color:var(--text3);">${r.hint}</div>
        </div>
        <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${r.color};">${r.val}</div>
      </div>`).join('')}
    </div>
    <div class="stitle">CLIENT-WISE ALLOCATION</div>
    <table class="tbl" style="font-size:10px;">
      <thead><tr><th>CLIENT</th><th>AUM ‚Çπ</th><th>LOTS</th><th>MARGIN ‚Çπ</th><th>MARGIN %</th><th>PREMIUM ‚Çπ</th></tr></thead>
      <tbody>
        ${clientRows.map(c=>`<tr>
          <td class="mono bold accent" style="font-size:14px;">${c.id}</td>
          <td class="mono">‚Çπ${fmt(c.aum)}</td>
          <td class="mono bold green">${c.clientLots}</td>
          <td class="mono">‚Çπ${fmt(c.clientMargin)}</td>
          <td class="mono ${c.clientMarginPct>60?'red':'green'}">${c.clientMarginPct.toFixed(1)}%</td>
          <td class="mono green">‚Çπ${fmt(c.clientPremium)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <div class="alert-box info mt8" style="font-size:10px;">
      <strong>Assumption:</strong> Loss per lot = Nifty ${movePct}% move √ó ${lotSize} lot size = ‚Çπ${fmt(lossPerLot)}.
      Actual loss depends on delta, gamma and strike distance. Always verify with broker margin calculator.
    </div>`;
}

function resetPositionSizing() {
  ['ps-capital','ps-premium','ps-margin'].forEach(id=>{ const e=el(id); if(e) e.value=''; });
  el('ps-risk-pct').value=2; el('ps-move').value=5; el('ps-lotsize').value=65;
  const r=el('ps-results'); if(r) r.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF REPORT GENERATOR ‚Äî pure browser, no server needed
// Uses window.print() with a styled print layout injected into a new window
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generatePDF() {
  toast('Generating PDF report...');
  const S = APP.settings;
  const nifty = S.nifty||25725;
  const today = new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  const time  = new Date().toLocaleTimeString('en-IN',{hour12:false});
  const regime = vixRegime(S.vix||12.6);

  // ‚îÄ‚îÄ Section 1: Portfolio summary
  let totalOptPnl=0, netDelta=0, netGamma=0, netTheta=0, netVega=0;
  APP.positions.forEach(p=>{ const pnl=calcPnl(p); if(pnl!==null) totalOptPnl+=pnl; const g=calcBS(p); netDelta+=g.netDelta; netGamma+=g.netGamma; netTheta+=g.netTheta; netVega+=g.netVega; });
  let totalEqPnl=0, totalEqDelta=0;
  APP.equity.forEach(eq=>{ const r=calcEquity(eq); totalEqPnl+=r.pnl; totalEqDelta+=r.delta; });

  // ‚îÄ‚îÄ Section 2: Positions table
  const posRows = APP.positions.map(p=>{
    const g=calcBS(p); const pnl=calcPnl(p); const dir=p.bs==='Buy'?1:-1; const qty=p.lotSize*p.lots*dir;
    return `<tr>
      <td>${p.inst} ${p.type} ${p.bs}</td>
      <td>${p.strike||'FUT'}</td>
      <td>${Math.ceil(calcDTE(p))}d</td>
      <td>${qty}</td>
      <td>‚Çπ${fmt(p.tradePrice,2)}</td>
      <td>‚Çπ${fmt(p.ltp,2)}</td>
      <td>${fmt(g.netDelta,3)}</td>
      <td>‚Çπ${fmt(g.netTheta,0)}</td>
      <td class="${pnl>=0?'pos':'neg'}">${pnl!==null?(pnl>=0?'+':'')+'‚Çπ'+fmt(pnl):'‚Äî'}</td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Section 3: Equity table
  const eqRows = APP.equity.map(eq=>{
    const r=calcEquity(eq);
    return `<tr>
      <td>${eq.stock}</td><td>${eq.dir}</td><td>${fmt(eq.qty)}</td>
      <td>‚Çπ${fmt(eq.cost,2)}</td><td>‚Çπ${fmt(eq.cmp,2)}</td>
      <td>‚Çπ${fmt(r.invested)}</td>
      <td class="${r.pnl>=0?'pos':'neg'}">${r.pnl>=0?'+':''}‚Çπ${fmt(r.pnl)}</td>
      <td>${(r.pnlPct*100).toFixed(2)}%</td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Section 4: Client P&L
  const clientRows = APP.clients.map(c=>{
    const ok=c.credit>=c.targetLo;
    return `<tr>
      <td><strong>${c.id}</strong></td>
      <td>‚Çπ${fmt(c.aum)}</td>
      <td>${c.structure}</td>
      <td>${c.lots}</td>
      <td class="pos">‚Çπ${fmt(c.credit)}</td>
      <td>‚Çπ${fmt(c.targetLo)}</td>
      <td>‚Çπ${fmt(c.targetHi)}</td>
      <td class="${ok?'pos':'warn'}">${ok?'ON TRACK':'BUILDING'}</td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Section 5: M2M history (last 10 days)
  const m2mRows = (APP.m2mHistory||[]).slice(-10).reverse().map(h=>{
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return `<tr>
      <td>${h.date}</td>
      <td>${days[new Date(h.date).getDay()]}</td>
      <td class="${h.optFutM2M>=0?'pos':'neg'}">${h.optFutM2M>=0?'+':''}‚Çπ${fmt(h.optFutM2M)}</td>
      <td class="${h.equityM2M>=0?'pos':'neg'}">${h.equityM2M>=0?'+':''}‚Çπ${fmt(h.equityM2M)}</td>
      <td class="${h.totalM2M>=0?'pos':'neg'}"><strong>${h.totalM2M>=0?'+':''}‚Çπ${fmt(h.totalM2M)}</strong></td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Section 6: Scenario table (key moves)
  const moves=[-0.10,-0.05,-0.03,0,0.03,0.05,0.10];
  const scenHeader = moves.map(m=>`<th>${m>0?'+':''}${(m*100).toFixed(0)}%<br><small>${Math.round(nifty*(1+m)).toLocaleString('en-IN')}</small></th>`).join('');
  let scenOptTotals=new Array(moves.length).fill(0);
  let scenEqTotals=new Array(moves.length).fill(0);
  APP.positions.forEach(p=>{
    const dir=p.bs==='Buy'?1:-1; const netQty=p.lotSize*p.lots*dir;
    const entryBs=p.type==='Future'?(p.spot||nifty):bsPrice(p,p.spot||nifty);
    moves.forEach((m,mi)=>{
      const s=nifty*(1+m);
      scenOptTotals[mi]+=p.type==='Future'?(s-(p.spot||nifty))*netQty:(bsPrice(p,s)-entryBs)*netQty;
    });
  });
  APP.equity.forEach(eq=>{ const r=calcEquity(eq); moves.forEach((m,mi)=>{ scenEqTotals[mi]+=r.delta*m; }); });
  const scenCombinedRow = moves.map((m,mi)=>{
    const v=scenOptTotals[mi]+scenEqTotals[mi];
    return `<td class="${v>=0?'pos':'neg'}" style="font-weight:700;">${v>=0?'+':''}‚Çπ${fmt(v)}</td>`;
  }).join('');

  // ‚îÄ‚îÄ Build full HTML for print window
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>RISK DESK Report ‚Äî ${today}</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',sans-serif;font-size:11px;color:#1a1a2e;padding:20px;background:#fff;}
    h1{font-size:18px;color:#0a0a23;letter-spacing:2px;margin-bottom:2px;}
    .subtitle{font-size:10px;color:#666;margin-bottom:16px;}
    .section{margin-bottom:20px;page-break-inside:avoid;}
    .section-title{font-size:11px;font-weight:700;letter-spacing:2px;color:#0a0a23;text-transform:uppercase;border-bottom:2px solid #00c8ff;padding-bottom:4px;margin-bottom:10px;}
    table{width:100%;border-collapse:collapse;font-size:10px;}
    th{background:#0a0a23;color:#00c8ff;padding:5px 7px;text-align:left;font-size:9px;letter-spacing:1px;}
    td{padding:4px 7px;border-bottom:1px solid #e8e8f0;}
    tr:nth-child(even) td{background:#f8f8ff;}
    .pos{color:#00a854;font-weight:600;}
    .neg{color:#cc2233;font-weight:600;}
    .warn{color:#cc7700;}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
    .kpi{background:#f0f8ff;border:1px solid #cce;border-radius:4px;padding:10px;}
    .kpi-label{font-size:8px;color:#666;letter-spacing:1px;text-transform:uppercase;}
    .kpi-val{font-size:18px;font-weight:700;color:#0a0a23;margin:2px 0;}
    .kpi-sub{font-size:9px;color:#888;}
    .regime-box{padding:10px;border-radius:4px;margin-bottom:10px;font-size:11px;}
    .regime-ok{background:#e8f8ee;border:1px solid #00a854;}
    .regime-warn{background:#fff8e8;border:1px solid #cc7700;}
    .regime-danger{background:#ffe8ea;border:1px solid #cc2233;}
    .highlight{background:#e8f8ff!important;}
    @media print{body{padding:10px;}h1{font-size:15px;}}
  </style>
  </head><body>
  <h1>‚¨° RISK DESK ‚Äî DAILY REPORT</h1>
  <div class="subtitle">Generated: ${today} at ${time} IST &nbsp;|&nbsp; Nifty: ${nifty.toLocaleString('en-IN')} &nbsp;|&nbsp; VIX: ${S.vix||'‚Äî'}</div>

  <!-- KPIs -->
  <div class="section">
    <div class="section-title">Portfolio Summary</div>
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-label">Nifty Spot</div><div class="kpi-val">${nifty.toLocaleString('en-IN')}</div></div>
      <div class="kpi"><div class="kpi-label">India VIX</div><div class="kpi-val">${S.vix||'‚Äî'}</div><div class="kpi-sub">${regime.label} regime</div></div>
      <div class="kpi"><div class="kpi-label">Opt/Fut P&L ‚Çπ</div><div class="kpi-val ${totalOptPnl>=0?'pos':'neg'}">${totalOptPnl>=0?'+':''}‚Çπ${fmt(totalOptPnl)}</div></div>
      <div class="kpi"><div class="kpi-label">Equity P&L ‚Çπ</div><div class="kpi-val ${totalEqPnl>=0?'pos':'neg'}">${totalEqPnl>=0?'+':''}‚Çπ${fmt(totalEqPnl)}</div></div>
      <div class="kpi"><div class="kpi-label">Combined P&L ‚Çπ</div><div class="kpi-val ${(totalOptPnl+totalEqPnl)>=0?'pos':'neg'}">${(totalOptPnl+totalEqPnl)>=0?'+':''}‚Çπ${fmt(totalOptPnl+totalEqPnl)}</div></div>
      <div class="kpi"><div class="kpi-label">Net Delta</div><div class="kpi-val">${fmt(netDelta,2)}</div></div>
      <div class="kpi"><div class="kpi-label">Net Theta/Day</div><div class="kpi-val pos">‚Çπ${fmt(netTheta,0)}</div></div>
      <div class="kpi"><div class="kpi-label">Net Vega/1%IV</div><div class="kpi-val">‚Çπ${fmt(netVega,0)}</div></div>
    </div>
  </div>

  <!-- VIX Regime -->
  <div class="section">
    <div class="section-title">VIX Regime & Alerts</div>
    <div class="regime-box ${regime.cls==='red'?'regime-danger':regime.cls==='orange'?'regime-warn':'regime-ok'}">
      <strong>VIX ${S.vix||'‚Äî'} ‚Äî ${regime.label}</strong><br>
      <span style="font-size:10px;">${regime.action}</span>
    </div>
    <table><thead><tr><th>ALERT</th><th>LEVEL</th><th>STATUS</th><th>ACTION</th></tr></thead><tbody>
      <tr><td>Put Side Stop-Loss</td><td>${(S.shortPE||0).toLocaleString('en-IN')}</td><td class="${nifty<(S.shortPE||0)?'neg':'pos'}">${nifty<(S.shortPE||0)?'üö® TRIGGERED':'‚úì CLEAR'}</td><td style="font-size:9px;">Close short PE immediately if triggered</td></tr>
      <tr><td>Call Side Stop-Loss</td><td>${(S.shortCE||0).toLocaleString('en-IN')}</td><td class="${nifty>(S.shortCE||0)?'neg':'pos'}">${nifty>(S.shortCE||0)?'üö® TRIGGERED':'‚úì CLEAR'}</td><td style="font-size:9px;">Close short CE for A&B if triggered</td></tr>
      <tr><td>VIX Alert</td><td>${S.vix||'‚Äî'}</td><td class="${(S.vix||0)>=20?'neg':(S.vix||0)>=17?'warn':'pos'}">${(S.vix||0)>=20?'üö® DEFENSIVE':(S.vix||0)>=17?'‚ö† CAUTIOUS':'‚úì OPTIMAL'}</td><td style="font-size:9px;">${regime.action.substring(0,60)}...</td></tr>
    </tbody></table>
  </div>

  <!-- Positions -->
  <div class="section">
    <div class="section-title">Open Positions with Greeks</div>
    <table><thead><tr><th>POSITION</th><th>STRIKE</th><th>DTE</th><th>QTY</th><th>TRADE ‚Çπ</th><th>LTP ‚Çπ</th><th>DELTA</th><th>THETA/DAY</th><th>P&L ‚Çπ</th></tr></thead>
    <tbody>${posRows}</tbody>
    <tfoot><tr style="background:#eef;font-weight:700;"><td colspan="6">TOTALS</td><td>${fmt(netDelta,2)}</td><td>‚Çπ${fmt(netTheta,0)}</td><td class="${totalOptPnl>=0?'pos':'neg'}">${totalOptPnl>=0?'+':''}‚Çπ${fmt(totalOptPnl)}</td></tr></tfoot>
    </table>
  </div>

  <!-- Equity -->
  <div class="section">
    <div class="section-title">Equity Book</div>
    <table><thead><tr><th>STOCK</th><th>DIR</th><th>QTY</th><th>COST ‚Çπ</th><th>CMP ‚Çπ</th><th>INVESTED ‚Çπ</th><th>P&L ‚Çπ</th><th>RETURN %</th></tr></thead>
    <tbody>${eqRows}</tbody>
    <tfoot><tr style="background:#eef;font-weight:700;"><td colspan="5">TOTAL</td><td>‚Äî</td><td class="${totalEqPnl>=0?'pos':'neg'}">${totalEqPnl>=0?'+':''}‚Çπ${fmt(totalEqPnl)}</td><td>‚Äî</td></tr></tfoot>
    </table>
  </div>

  <!-- Client Summary -->
  <div class="section">
    <div class="section-title">Client-wise P&L Summary</div>
    <table><thead><tr><th>CLIENT</th><th>AUM ‚Çπ</th><th>STRUCTURE</th><th>LOTS</th><th>CREDIT ‚Çπ</th><th>TARGET LO ‚Çπ</th><th>TARGET HI ‚Çπ</th><th>STATUS</th></tr></thead>
    <tbody>${clientRows}</tbody></table>
  </div>

  <!-- Scenario P&L -->
  <div class="section">
    <div class="section-title">Scenario P&L (Combined)</div>
    <table><thead><tr><th>SCENARIO</th>${scenHeader}</tr></thead><tbody>
    <tr><td><strong>Combined P&L ‚Çπ</strong></td>${scenCombinedRow}</tr>
    </tbody></table>
  </div>

  <!-- M2M History -->
  <div class="section">
    <div class="section-title">M2M History (Last 10 Days)</div>
    ${m2mRows ? `<table><thead><tr><th>DATE</th><th>DAY</th><th>OPT/FUT M2M ‚Çπ</th><th>EQUITY M2M ‚Çπ</th><th>TOTAL M2M ‚Çπ</th></tr></thead><tbody>${m2mRows}</tbody></table>` : '<p style="color:#888;font-size:10px;">No M2M history yet. Will populate after first 3:30 PM snapshot.</p>'}
  </div>

  <div style="margin-top:20px;padding-top:10px;border-top:1px solid #ccc;font-size:9px;color:#999;">
    RISK DESK ‚Äî Personal trading dashboard ¬∑ Generated ${today} ${time} IST ¬∑ For personal use only
  </div>

  <script>window.onload=function(){window.print();}<\/script>
  </body></html>`;

  const w = window.open('','_blank');
  if (!w) { toast('Allow popups to generate PDF', true); return; }
  w.document.write(html);
  w.document.close();
  toast('PDF report opened ‚Äî use Ctrl+P to save as PDF');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY M2M ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// M2M data structure stored in Firebase + localStorage:
// APP.m2mHistory = [ { date, optFutM2M, equityM2M, totalM2M, positions:[], note } ]
// APP.m2mSnapshots = { 'YYYY-MM-DD': { positions:[{inst,type,bs,lots,ltp}], equity:[{stock,cmp}], ts } }

function todayIST() {
  const now = new Date();
  const ist = new Date(now.getTime() + 5.5*3600000);
  return ist.toISOString().slice(0,10);
}

function istHHMM() {
  const now = new Date();
  const ist = new Date(now.getTime() + 5.5*3600000);
  return ist.getUTCHours()*60 + ist.getUTCMinutes();
}

// Take a snapshot of all current LTPs ‚Äî called at 3:30 PM auto or manually
function takeM2MSnapshot(mode) {
  const dateKey = todayIST();
  const ts = new Date().toISOString();

  // Snapshot all positions LTP
  const posSnap = APP.positions.map(p => ({
    inst:p.inst, type:p.type, bs:p.bs, strike:p.strike,
    lots:p.lots, lotSize:p.lotSize, ltp:p.ltp||0, notes:p.notes
  }));

  // Snapshot all equity CMP
  const eqSnap = APP.equity.map(e => ({
    stock:e.stock, dir:e.dir, qty:e.qty, cmp:e.cmp||0
  }));

  if (!APP.m2mSnapshots) APP.m2mSnapshots = {};
  APP.m2mSnapshots[dateKey] = { positions:posSnap, equity:eqSnap, ts, mode };

  saveState();

  // Also compute M2M vs yesterday and save to history
  computeAndSaveM2M(dateKey);

  const statusEl = el('m2m-snapshot-status');
  const t = new Date().toLocaleTimeString('en-IN',{hour12:false});
  if (statusEl) statusEl.textContent = '‚úì Snapshot saved at ' + t + ' (' + (mode==='auto'?'auto 3:30PM':'manual') + ')';

  toast(mode==='auto' ? 'Auto M2M snapshot at 3:30 PM ‚úì' : 'M2M snapshot saved ‚úì');
  renderM2MPage();
}

function computeAndSaveM2M(dateKey) {
  if (!APP.m2mSnapshots) return;
  const snap = APP.m2mSnapshots[dateKey];
  if (!snap) return;

  // Find yesterday's snapshot
  const dates = Object.keys(APP.m2mSnapshots).sort();
  const idx = dates.indexOf(dateKey);
  if (idx < 1) return; // no previous day to compare
  const prevKey = dates[idx-1];
  const prevSnap = APP.m2mSnapshots[prevKey];
  if (!prevSnap) return;

  // Calculate options/futures M2M
  let optFutM2M = 0;
  const posDetails = [];
  snap.positions.forEach(p => {
    const prev = prevSnap.positions.find(pp =>
      pp.inst===p.inst && pp.type===p.type && pp.bs===p.bs && pp.strike===p.strike
    );
    if (!prev) return;
    const dir = p.bs==='Buy' ? 1 : -1;
    const qty = p.lotSize * p.lots * dir;
    const m2m = (p.ltp - prev.ltp) * qty;
    optFutM2M += m2m;
    posDetails.push({
      label: p.inst+' '+p.type+(p.strike?' '+p.strike:'')+' '+p.bs,
      prevLtp: prev.ltp, currLtp: p.ltp, qty, m2m
    });
  });

  // Calculate equity M2M
  let equityM2M = 0;
  snap.equity.forEach(e => {
    const prev = prevSnap.equity.find(pe => pe.stock===e.stock);
    if (!prev) return;
    const dir = e.dir==='Long' ? 1 : -1;
    const m2m = (e.cmp - prev.cmp) * e.qty * dir;
    equityM2M += m2m;
  });

  const totalM2M = optFutM2M + equityM2M;

  // Save to history ‚Äî update if date exists, else add
  if (!APP.m2mHistory) APP.m2mHistory = [];
  const existing = APP.m2mHistory.findIndex(h => h.date===dateKey);
  const entry = { date:dateKey, optFutM2M, equityM2M, totalM2M, positions:posDetails, note:'' };
  if (existing >= 0) APP.m2mHistory[existing] = entry;
  else APP.m2mHistory.push(entry);

  // Keep only last 90 days
  APP.m2mHistory.sort((a,b)=>a.date.localeCompare(b.date));
  if (APP.m2mHistory.length > 90) APP.m2mHistory = APP.m2mHistory.slice(-90);

  saveState();
}

// Auto-snapshot check ‚Äî called every minute alongside market refresh
function checkM2MAutoSnapshot() {
  const mins = istHHMM();
  const dateKey = todayIST();
  // Trigger at 3:30 PM IST (930 mins) ‚Äî only once per day
  if (mins >= 930 && mins <= 932) {
    const snap = APP.m2mSnapshots && APP.m2mSnapshots[dateKey];
    const isAutoToday = snap && snap.mode === 'auto';
    if (!isAutoToday) takeM2MSnapshot('auto');
  }
}

function renderM2MPage() {
  const today = todayIST();
  const mins = istHHMM();
  const marketOpen = mins >= 555; // after 9:15 AM

  if (!APP.m2mHistory) APP.m2mHistory = [];
  if (!APP.m2mSnapshots) APP.m2mSnapshots = {};

  // ‚îÄ‚îÄ Today's M2M ‚îÄ‚îÄ
  // Find today in history (populated after 3:30 PM snapshot)
  const todayEntry = APP.m2mHistory.find(h => h.date===today);
  const todaySnap = APP.m2mSnapshots[today];

  // Today's M2M card
  const m2mTodayEl = el('m2m-today');
  const m2mTodaySubEl = el('m2m-today-sub');
  if (todayEntry) {
    const v = todayEntry.totalM2M;
    if(m2mTodayEl) { m2mTodayEl.innerHTML = fmtPnl(v); }
    if(m2mTodaySubEl) m2mTodaySubEl.textContent = 'vs yesterday close ¬∑ ' + today;
  } else {
    if(m2mTodayEl) m2mTodayEl.textContent = '‚Äî';
    if(m2mTodaySubEl) m2mTodaySubEl.textContent = mins < 930 ? 'Snapshot at 3:30 PM' : 'Take snapshot to calculate';
  }

  // ‚îÄ‚îÄ Per-position table ‚îÄ‚îÄ
  const posBody = el('m2m-pos-body');
  if (posBody) {
    posBody.innerHTML = '';
    if (todayEntry && todayEntry.positions.length > 0) {
      let total = 0;
      todayEntry.positions.forEach(p => {
        total += p.m2m;
        posBody.innerHTML += `<tr>
          <td class="mono bold">${p.label}</td>
          <td class="mono">‚Çπ${fmt(p.prevLtp,2)}</td>
          <td class="mono accent">‚Çπ${fmt(p.currLtp,2)}</td>
          <td class="mono ${p.currLtp>=p.prevLtp?'green':'red'}">${p.currLtp>=p.prevLtp?'+':''}‚Çπ${fmt(p.currLtp-p.prevLtp,2)}</td>
          <td class="mono">${p.qty}</td>
          <td class="mono">${fmtPnl(p.m2m)}</td>
        </tr>`;
      });
      posBody.innerHTML += `<tr class="total-row">
        <td colspan="5" class="mono">TOTAL OPT/FUT M2M</td>
        <td class="mono">${fmtPnl(todayEntry.optFutM2M)}</td>
      </tr>
      <tr class="total-row">
        <td colspan="5" class="mono">EQUITY M2M</td>
        <td class="mono">${fmtPnl(todayEntry.equityM2M)}</td>
      </tr>
      <tr class="total-row" style="background:rgba(0,200,255,.08);">
        <td colspan="5" class="mono accent">COMBINED M2M</td>
        <td class="mono">${fmtPnl(todayEntry.totalM2M)}</td>
      </tr>`;
    } else {
      posBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:20px;">
        No M2M data yet for today.<br>
        <span style="font-size:10px;">Snapshot auto-taken at 3:30 PM ¬∑ or click TAKE SNAPSHOT NOW</span>
      </td></tr>`;
    }
  }

  // ‚îÄ‚îÄ Last snapshot info ‚îÄ‚îÄ
  const lastSnapEl = el('m2m-last-snapshot');
  if (lastSnapEl) {
    if (todaySnap) {
      const t = new Date(todaySnap.ts).toLocaleTimeString('en-IN',{hour12:false});
      lastSnapEl.className = 'alert-box ok';
      lastSnapEl.innerHTML = `‚úì Today's snapshot saved at <strong>${t}</strong> (${todaySnap.mode==='auto'?'auto':'manual'})<br>
        <span style="font-size:10px;">${todaySnap.positions.length} positions ¬∑ ${todaySnap.equity.length} stocks captured</span>`;
    } else {
      lastSnapEl.className = 'alert-box warning';
      lastSnapEl.textContent = 'No snapshot yet today. Will auto-take at 3:30 PM IST, or click TAKE SNAPSHOT NOW.';
    }
  }

  // ‚îÄ‚îÄ Month summary ‚îÄ‚îÄ
  const monthKey = today.slice(0,7); // YYYY-MM
  const monthEntries = APP.m2mHistory.filter(h => h.date.startsWith(monthKey));
  const monthTotal = monthEntries.reduce((s,h)=>s+h.totalM2M, 0);
  const bestDay = monthEntries.length ? monthEntries.reduce((b,h)=>h.totalM2M>b.totalM2M?h:b) : null;
  const worstDay = monthEntries.length ? monthEntries.reduce((w,h)=>h.totalM2M<w.totalM2M?h:w) : null;
  const winDays = monthEntries.filter(h=>h.totalM2M>0).length;

  const m2mMonthEl = el('m2m-month');
  if(m2mMonthEl) m2mMonthEl.innerHTML = fmtPnl(monthTotal);
  const m2mMonthSubEl = el('m2m-month-sub');
  if(m2mMonthSubEl) m2mMonthSubEl.textContent = monthEntries.length + ' trading days ¬∑ ' + winDays + ' profitable';

  const bestEl = el('m2m-best');
  if(bestEl) bestEl.innerHTML = bestDay ? fmtPnl(bestDay.totalM2M) : '‚Äî';
  const bestDateEl = el('m2m-best-date');
  if(bestDateEl) bestDateEl.textContent = bestDay ? bestDay.date : '‚Äî';

  const worstEl = el('m2m-worst');
  if(worstEl) worstEl.innerHTML = worstDay ? fmtPnl(worstDay.totalM2M) : '‚Äî';
  const worstDateEl = el('m2m-worst-date');
  if(worstDateEl) worstDateEl.textContent = worstDay ? worstDay.date : '‚Äî';

  // Month summary card
  const summaryEl = el('m2m-month-summary');
  if (summaryEl) {
    summaryEl.innerHTML = [
      {label:'Trading Days', val:monthEntries.length},
      {label:'Profitable Days', val:winDays+' / '+monthEntries.length},
      {label:'Avg Daily M2M', val:'‚Çπ'+fmt(monthEntries.length?monthTotal/monthEntries.length:0)},
      {label:'Best Day', val:bestDay?('‚Çπ'+fmt(bestDay.totalM2M)+' ('+bestDay.date+')') :'‚Äî'},
      {label:'Worst Day', val:worstDay?('‚Çπ'+fmt(worstDay.totalM2M)+' ('+worstDay.date+')') :'‚Äî'},
      {label:'Month Total', val:'‚Çπ'+fmt(monthTotal)},
    ].map(r=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
      <span style="font-family:var(--mono);font-size:9px;color:var(--text3);">${r.label}</span>
      <span style="font-family:var(--mono);font-size:10px;color:var(--text);">${r.val}</span>
    </div>`).join('');
  }

  // ‚îÄ‚îÄ 30-day history table ‚îÄ‚îÄ
  const histBody = el('m2m-history-body');
  if (histBody) {
    const recent = [...APP.m2mHistory].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,30);
    if (recent.length === 0) {
      histBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:20px;">
        No history yet. Snapshots will appear here after 3:30 PM each day.
      </td></tr>`;
    } else {
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      histBody.innerHTML = recent.map(h => {
        const d = new Date(h.date);
        const dayName = days[d.getDay()];
        const cls = h.totalM2M>0?'green':h.totalM2M<0?'red':'text3';
        return `<tr>
          <td class="mono">${h.date}</td>
          <td class="mono" style="color:var(--text3);">${dayName}</td>
          <td class="mono ${h.optFutM2M>=0?'green':'red'}">${h.optFutM2M>=0?'+':''}‚Çπ${fmt(h.optFutM2M)}</td>
          <td class="mono ${h.equityM2M>=0?'green':'red'}">${h.equityM2M>=0?'+':''}‚Çπ${fmt(h.equityM2M)}</td>
          <td class="mono bold ${cls}">${h.totalM2M>=0?'+':''}‚Çπ${fmt(h.totalM2M)}</td>
          <td class="mono" style="font-size:9px;">${h.positions?h.positions.length+' pos':'‚Äî'}</td>
          <td style="font-size:9px;color:var(--text3);">${h.note||''}</td>
        </tr>`;
      }).join('');
    }
  }
}

function exportM2MHistory() {
  if (!APP.m2mHistory || APP.m2mHistory.length===0) { toast('No history to export',true); return; }
  const rows = [['Date','Day','OPT/FUT M2M','Equity M2M','Total M2M']];
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  APP.m2mHistory.forEach(h => {
    rows.push([h.date, days[new Date(h.date).getDay()], h.optFutM2M.toFixed(0), h.equityM2M.toFixed(0), h.totalM2M.toFixed(0)]);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'm2m_history_'+todayIST()+'.csv';
  a.click();
  toast('M2M history exported ‚úì');
}

function clearM2MHistory() {
  if (!confirm('Clear all M2M history? This cannot be undone.')) return;
  APP.m2mHistory = [];
  APP.m2mSnapshots = {};
  saveState();
  renderM2MPage();
  toast('M2M history cleared');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE PRICE FETCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let autoRefreshTimer = null;
let autoRefreshOn = false;

// Uses allorigins CORS proxy ‚Üí Yahoo Finance v8 quote API
async function fetchYahooPrice(symbol) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=1d&range=1d`;
  const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
  try {
    const res = await fetch(proxy, { signal: AbortSignal.timeout(8000) });
    const data = await res.json();
    const meta = data?.chart?.result?.[0]?.meta;
    if (!meta) return null;
    return {
      price: meta.regularMarketPrice || meta.previousClose,
      prevClose: meta.previousClose,
      change: (meta.regularMarketPrice - meta.previousClose),
      changePct: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose * 100),
      symbol
    };
  } catch(e) { return null; }
}

async function fetchLivePrices() {
  const badge = el('live-status-badge');
  badge.innerHTML = `<span class="live-dot orange"></span>FETCHING...`;
  el('fetch-note').textContent = 'Fetching live prices via Yahoo Finance proxy...';

  const fetchResults = [];
  let updated = 0;

  // Nifty
  const niftyData = await fetchYahooPrice('^NSEI');
  if (niftyData?.price) {
    APP.settings.nifty = Math.round(niftyData.price * 100) / 100;
    fetchResults.push({ sym:'NIFTY', ...niftyData });
    updated++;
  }

  // VIX
  const vixData = await fetchYahooPrice('^INDIAVIX');
  if (vixData?.price) {
    APP.settings.vix = Math.round(vixData.price * 100) / 100;
    fetchResults.push({ sym:'VIX', ...vixData });
    updated++;
  }

  // Equity symbols
  for (const eq of APP.equity) {
    if (!eq.yahoo) continue;
    const d = await fetchYahooPrice(eq.yahoo);
    if (d?.price) {
      eq.cmp = Math.round(d.price * 100) / 100;
      fetchResults.push({ sym: eq.stock, ...d });
      updated++;
    }
  }

  // Render tickers
  const tickerWrap = el('ticker-wrap');
  tickerWrap.innerHTML = fetchResults.map(r => {
    const chgCls = r.change >= 0 ? 'up' : 'dn';
    const sign = r.change >= 0 ? '+' : '';
    return `<div class="price-ticker">
      <span class="sym">${r.sym}</span>
      <span class="price ${r.change >= 0 ? 'green' : 'red'}">${r.price?.toLocaleString('en-IN',{maximumFractionDigits:2})}</span>
      <span class="chg ${chgCls}">${sign}${r.changePct?.toFixed(2)}%</span>
    </div>`;
  }).join('');

  if (updated > 0) {
    const t = new Date().toLocaleTimeString('en-IN',{hour12:false});
    el('last-fetch-time').textContent = `Last: ${t}`;
    el('fetch-log').textContent = `‚úì Fetched ${updated} symbols at ${t}`;
    badge.innerHTML = `<span class="live-dot"></span>LIVE ¬∑ ${t}`;
    el('fetch-note').textContent = `‚úì ${updated} prices updated from Yahoo Finance. Nifty: ${APP.settings.nifty?.toLocaleString('en-IN')} ¬∑ VIX: ${APP.settings.vix}`;
    saveState();
    renderAll();
    // Update settings form if open
    loadSettingsForm();
    toast(`Live prices updated ‚úì (${updated} symbols)`);
  } else {
    badge.innerHTML = `<span class="live-dot red"></span>FETCH FAILED`;
    el('fetch-note').textContent = '‚ö† Could not fetch live prices. Yahoo proxy may be unavailable or market is closed. Update manually in Settings.';
    el('fetch-log').textContent = '‚úó All fetches failed. Check internet connection or try again.';
    toast('Live fetch failed ‚Äî use manual input', true);
  }

  // Update equity symbols list in settings
  renderEqSymbolsList();
}

function isMarketOpen() {
  const now = new Date();
  const ist = new Date(now.getTime() + 5.5 * 3600000);
  const day = ist.getUTCDay();
  if (day === 0 || day === 6) return false;
  const mins = ist.getUTCHours() * 60 + ist.getUTCMinutes();
  return mins >= 555 && mins <= 930;
}

function smartRefreshTick() {
  if (!autoRefreshOn) return;
  // Check M2M auto-snapshot at 3:30 PM regardless of market open status
  checkM2MAutoSnapshot();
  if (isMarketOpen()) {
    fetchLivePrices();
    el('auto-refresh-status').textContent = 'ON ‚Ä¢ LIVE 1min';
  } else {
    el('auto-refresh-status').textContent = 'ON ‚Ä¢ MKT CLOSED';
  }
}

function toggleAutoRefresh() {
  autoRefreshOn = !autoRefreshOn;
  if (autoRefreshOn) {
    autoRefreshTimer = setInterval(smartRefreshTick, 60000);
    const status = isMarketOpen() ? 'ON ‚Ä¢ LIVE 1min' : 'ON ‚Ä¢ MKT CLOSED';
    el('auto-refresh-status').textContent = status;
    if (isMarketOpen()) fetchLivePrices();
    toast('Auto-refresh ON: every 1 min during NSE hours (9:15-15:30 IST)');
  } else {
    clearInterval(autoRefreshTimer);
    el('auto-refresh-status').textContent = 'OFF';
    toast('Auto-refresh disabled');
  }
}

function renderEqSymbolsList() {
  const c = el('eq-symbols-list');
  if (!c) return;
  c.innerHTML = APP.equity.map((eq,i) =>
    `<div style="display:flex;gap:8px;margin-bottom:6px;align-items:center;">
      <span style="font-family:var(--mono);font-size:10px;color:var(--text2);width:100px;">${eq.stock}</span>
      <input style="background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:4px 8px;flex:1;" value="${eq.yahoo||''}" placeholder="SYMBOL.NS" onchange="APP.equity[${i}].yahoo=this.value;saveState();">
    </div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(n, d=0) {
  if (n===null||n===undefined||isNaN(n)) return '‚Äî';
  return n.toLocaleString('en-IN',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function fmtPnl(n) {
  if (n===null||isNaN(n)) return '<span style="color:var(--text3)">‚Äî</span>';
  const cls = n>0?'green':n<0?'red':'text3';
  return `<span class="${cls}">${n>0?'+':''}‚Çπ${fmt(n)}</span>`;
}
function fmtPct(n) {
  if (n===null||isNaN(n)) return '‚Äî';
  const cls = n>0?'green':n<0?'red':'text3';
  return `<span class="${cls}">${(n*100).toFixed(2)}%</span>`;
}
function chip(txt,cls) { return `<span class="chip badge-${cls}">${txt}</span>`; }
function el(id) { return document.getElementById(id); }

function calcPnl(pos) {
  const dir = pos.bs==='Buy'?1:-1;
  const netQty = pos.lotSize*pos.lots*dir;
  if (!pos.ltp||!pos.tradePrice) return null;
  return (pos.ltp - pos.tradePrice)*netQty;
}

function calcEquity(eq) {
  const dir = eq.dir==='Long'?1:-1;
  const invested = eq.qty*eq.cost;
  const currVal  = eq.qty*(eq.cmp||eq.cost);
  const pnl      = (eq.cmp-eq.cost)*eq.qty*dir;
  const pnlPct   = eq.cost?pnl/invested:0;
  const delta    = currVal*dir;
  const betaDelta= delta*(eq.beta||1);
  return {invested,currVal,pnl,pnlPct,delta,betaDelta};
}

function vixRegime(vix) {
  if (vix<13)  return {label:'LOW VOL',  cls:'green',  action:'Premiums thin. Spreads only. Do not tighten strikes. VIX spike is your short-vega enemy.'};
  if (vix<17)  return {label:'OPTIMAL',  cls:'blue',   action:'Best zone. Full iron condor A&B. Full spreads C D E. Weekly strangles for A.'};
  if (vix<20)  return {label:'CAUTIOUS', cls:'orange', action:'Stop strangles immediately. Spreads only. Buy 24,500 PE tail hedge for A & B.'};
  return         {label:'DEFENSIVE', cls:'red',    action:'CLOSE ALL SHORT POSITIONS NOW. Hold NiftyBees only. Re-enter when VIX < 17 for 3 days.'};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tick() {
  const now = new Date();
  const isMarketHours = now.getDay()>0&&now.getDay()<6&&
    (now.getHours()>9||(now.getHours()===9&&now.getMinutes()>=15))&&
    (now.getHours()<15||(now.getHours()===15&&now.getMinutes()<=30));
  el('clock').textContent = now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})+' ¬∑ '+now.toLocaleTimeString('en-IN',{hour12:false});
}
setInterval(tick,1000); tick();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(id) {
  try {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    const pg = el('page-'+id);
    if (!pg) { console.warn('No page found for id:', id); return; }
    pg.classList.add('active');
    // Find the tab by its onclick attribute ‚Äî more robust than index
    document.querySelectorAll('.nav-tab').forEach(t => {
      if (t.getAttribute('onclick') && t.getAttribute('onclick').includes("'"+id+"'")) {
        t.classList.add('active');
      }
    });
    if(id==='settings'){loadSettingsForm();}
    if(id==='greeks'){renderGreeksDeepDive();}
    if(id==='m2m'){renderM2MPage();}
    if(id==='sync'){try{updateSyncUI();}catch(e){console.warn('updateSyncUI error:',e);}}
  } catch(e) { console.error('switchPage error:', e); }
}

function toast(msg,err=false) {
  const t=el('toast'); t.textContent=msg;
  t.className='toast show'+(err?' error':'');
  setTimeout(()=>t.className='toast',3000);
}

function renderAll() {
  renderDashboard();
  renderPositions();
  renderEquity();
  renderScenario();
  renderAlerts();
  renderClientCfg();
  // Refresh M2M page if it's active
  if (el('page-m2m') && el('page-m2m').classList.contains('active')) renderM2MPage();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const S = APP.settings;
  let totalOptPnl=0, netDelta=0, netGamma=0, netTheta=0, netVega=0;

  APP.positions.forEach(p=>{
    const pnl=calcPnl(p); if(pnl!==null) totalOptPnl+=pnl;
    const g=calcBS(p);
    netDelta+=g.netDelta; netGamma+=g.netGamma; netTheta+=g.netTheta; netVega+=g.netVega;
  });

  let totalEqPnl=0,totalEqDelta=0,totalBetaDelta=0;
  APP.equity.forEach(eq=>{
    const r=calcEquity(eq);
    totalEqPnl+=r.pnl; totalEqDelta+=r.delta; totalBetaDelta+=r.betaDelta;
  });

  const totalPnl=totalOptPnl+totalEqPnl;
  const nifty=S.nifty||25725;

  // KPIs
  el('d-nifty').textContent=nifty.toLocaleString('en-IN');
  const sdMove=Math.round(nifty*(S.vix||12.6)/100*Math.sqrt((S.dte||40)/365));
  el('d-nifty-sub').textContent=`1 SD: ${(nifty-sdMove).toLocaleString('en-IN')} ‚Äì ${(nifty+sdMove).toLocaleString('en-IN')}`;
  el('d-vix').textContent=S.vix||'‚Äî';
  el('d-vix2').textContent=S.vix||'‚Äî';

  const regime=vixRegime(S.vix||12.6);
  el('d-vix-regime').textContent=regime.label+' regime';
  el('d-vix-badge2').textContent=regime.label;
  el('d-vix-badge2').className=`badge badge-${regime.cls} mt6`;
  el('d-vix-action').textContent=regime.action;
  el('d-vix-action').className=`alert-box ${regime.cls==='red'?'danger':regime.cls==='orange'?'warning':'ok'} mt6`;
  el('nifty-badge').textContent='NIFTY: '+nifty.toLocaleString('en-IN');
  el('vix-badge').textContent='VIX: '+(S.vix||'‚Äî');
  el('vix-badge').className=`badge badge-${regime.cls==='green'?'green':regime.cls==='blue'?'blue':regime.cls==='orange'?'orange':'red'}`;

  el('d-opt-pnl').innerHTML=fmtPnl(totalOptPnl);
  el('d-eq-pnl').innerHTML=fmtPnl(totalEqPnl);
  el('d-total-pnl').innerHTML=fmtPnl(totalPnl);

  const deltaExp=netDelta*nifty;
  el('d-net-delta').textContent=fmt(netDelta,2);
  el('d-delta-exp').innerHTML=`<span class="${deltaExp>=0?'green':'red'}">‚Çπ${fmt(Math.abs(deltaExp))}</span>`;
  el('d-gamma').textContent=fmt(netGamma,4);
  el('d-gamma').style.color=netGamma<0?'var(--red)':'var(--green)';
  el('d-theta').textContent='‚Çπ'+fmt(netTheta,0);
  el('d-vega').textContent='‚Çπ'+fmt(netVega,0);
  el('d-eq-delta').textContent='‚Çπ'+fmt(totalEqDelta);
  el('d-eq-beta-delta').textContent='‚Çπ'+fmt(totalBetaDelta);
  const pnl1pct=deltaExp*0.01+totalEqDelta*0.01;
  el('d-pnl-1pct').textContent='‚Çπ'+fmt(pnl1pct);
  el('d-pnl-1pct').className='kpi-val kpi-xs '+(pnl1pct>=0?'green':'red');

  // DTE
  const dte=S.dte||40;
  el('d-dte').textContent=dte+' days';
  el('d-credit').textContent='‚Çπ'+fmt(S.credit||0);
  const dtePct=Math.max(5,Math.min(95,(1-dte/40)*100));
  const dteBar=el('d-dte-bar');
  dteBar.style.width=dtePct+'%';
  dteBar.className='gauge-fill '+(dte<=7?'gauge-red':dte<=14?'gauge-orange':'gauge-green');
  el('d-dte-note').textContent=dte<=7?'üö® DANGER ZONE ‚Äî Close all positions immediately!':
    dte<=14?'‚ö† Last 2 weeks ‚Äî daily monitoring, prepare to close':
    '‚úì Theta working in your favour ‚Äî hold course';

  renderRangeBar(S);
  renderCalendar(dte,S.credit||0);

  // Mini positions table
  const miniBody=el('d-positions-mini').querySelector('tbody');
  miniBody.innerHTML='';
  APP.positions.forEach(p=>{
    const pnl=calcPnl(p);
    const g=calcBS(p);
    const dir=p.bs==='Buy'?1:-1;
    miniBody.innerHTML+=`<tr>
      <td class="mono bold">${p.inst}</td><td>${p.type}</td>
      <td>${chip(p.bs,p.bs==='Buy'?'green':'orange')}</td>
      <td class="mono">${p.lotSize*p.lots*dir}</td>
      <td class="mono ${g.netDelta>=0?'green':'red'}">${fmt(g.netDelta,2)}</td>
      <td class="mono">${fmtPnl(pnl)}</td>
    </tr>`;
  });

  // Client table
  const clientBody=el('d-client-tbl').querySelector('tbody');
  clientBody.innerHTML='';
  APP.clients.forEach(c=>{
    const creditPct=((c.credit/c.aum)*100).toFixed(3);
    const ok=c.credit>=c.targetLo;
    clientBody.innerHTML+=`<tr>
      <td class="bold mono accent" style="font-size:16px;">${c.id}</td>
      <td class="mono">‚Çπ${fmt(c.aum)}</td>
      <td style="font-size:10px;">${c.structure}</td>
      <td class="mono">${c.lots}</td>
      <td class="mono green">‚Çπ${fmt(c.credit)}</td>
      <td class="mono">‚Çπ${fmt(c.targetLo)}</td>
      <td class="mono">‚Çπ${fmt(c.targetHi)}</td>
      <td class="mono ${ok?'green':'orange'}">${creditPct}%</td>
      <td>${chip(ok?'ON TRACK':'BUILDING',ok?'green':'orange')}</td>
    </tr>`;
  });
}

function renderRangeBar(S) {
  const nifty=S.nifty||25725;
  const lPE=S.longPE||24800,sPE=S.shortPE||25200;
  const sCE=S.shortCE||26200,lCE=S.longCE||26500;
  const min=lPE-300,max=lCE+300;
  const pct=((nifty-min)/(max-min)*100);
  el('range-pin').style.left=Math.max(2,Math.min(98,pct))+'%';
  el('range-pin-lbl').textContent=nifty.toLocaleString('en-IN');
  el('range-ticks').innerHTML=[lPE,sPE,Math.round((sPE+sCE)/2),sCE,lCE].map(t=>
    `<span style="font-family:var(--mono);font-size:8px;color:var(--text3);">${t.toLocaleString('en-IN')}</span>`
  ).join('');
}

function renderCalendar(dte,credit) {
  const total=40,elapsed=total-dte,danger=total-7;
  const wrap=el('cal-wrap'); wrap.innerHTML='';
  for(let i=1;i<=total;i++){
    const d=document.createElement('div');
    if(i===total){d.className='cal-day cal-expiry';d.textContent='EXP';}
    else if(i<elapsed){d.className='cal-day cal-elapsed';d.textContent=i;}
    else if(i===elapsed){d.className='cal-day cal-today';d.textContent='NOW';}
    else if(i>=danger){d.className='cal-day cal-danger';d.textContent=i;}
    else{d.className='cal-day cal-remaining';d.textContent=i;}
    wrap.appendChild(d);
  }
  const decayed=Math.round(credit*elapsed/total);
  const sum=el('cal-summary');
  if(dte<=7){sum.className='alert-box danger';sum.textContent='üö® DANGER ZONE ‚Äî Close all positions immediately. Gamma spikes unpredictably.';}
  else{sum.className='alert-box info';sum.textContent=`Day ${elapsed}/${total} ¬∑ Credit decayed: ‚Çπ${fmt(decayed)} ¬∑ Remaining: ‚Çπ${fmt(credit-decayed)} ¬∑ ${dte<=14?'‚ö† Approaching danger zone':'‚úì Hold course'}`;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POSITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPositions() {
  const body=el('opt-body'); body.innerHTML='';
  let totalPnl=0,netDelta=0,netGamma=0,netTheta=0,netVega=0;

  // Update the live Greeks status badges
  const spotB=el('greeks-spot-badge'), ivB=el('greeks-iv-badge'), dteB=el('greeks-dte-badge');
  if(spotB) {
    const sp=APP.settings.nifty;
    spotB.textContent='SPOT: '+(sp?sp.toLocaleString('en-IN'):'‚Äî');
    spotB.className='badge '+(sp?'badge-blue':'badge-gray');
  }
  if(ivB) {
    if(APP.settings.useLiveVix && APP.settings.vix) {
      ivB.textContent='IV: VIX '+APP.settings.vix+'%';
      ivB.className='badge badge-orange';
    } else {
      ivB.textContent='IV: ENTRY (manual)';
      ivB.className='badge badge-gray';
    }
  }
  if(dteB) {
    const sampleDTE = APP.positions.length>0 ? Math.ceil(calcDTE(APP.positions.find(p=>p.expiry)||APP.positions[0])) : '‚Äî';
    dteB.textContent='DTE: auto ('+sampleDTE+'d to expiry)';
    dteB.className='badge badge-accent';
  }

  APP.positions.forEach((p,idx)=>{
    const dir=p.bs==='Buy'?1:-1;
    const netQty=p.lotSize*p.lots*dir;
    const pnl=calcPnl(p); if(pnl!==null) totalPnl+=pnl;
    const g=calcBS(p);
    netDelta+=g.netDelta; netGamma+=g.netGamma; netTheta+=g.netTheta; netVega+=g.netVega;

    body.innerHTML+=`<tr>
      <td class="mono">${idx+1}</td>
      <td class="bold">${p.inst}</td><td>${p.type}</td>
      <td>${chip(p.bs,p.bs==='Buy'?'green':'orange')}</td>
      <td class="mono">${fmt(p.spot)}</td>
      <td class="mono">${p.strike?fmt(p.strike):'‚Äî'}</td>
      <td class="mono" title="${APP.settings.useLiveVix ? 'Using live VIX: '+APP.settings.vix+'%' : 'Entry IV: '+(p.iv||'‚Äî')}"><span style="${APP.settings.useLiveVix?'color:var(--orange);font-size:9px;':''}">${APP.settings.useLiveVix?'‚ö°':''}</span>${APP.settings.useLiveVix ? fmt(APP.settings.vix,1)+'%' : (p.iv ? p.iv+'%' : '‚Äî')}</td>
      <td class="mono accent" title="Expiry: ${p.expiry||'-'} (auto-calculates daily)">${Math.ceil(calcDTE(p))}</td>
      <td class="mono">${p.lotSize}</td><td class="mono">${p.lots}</td>
      <td class="mono bold ${netQty>0?'green':'orange'}">${netQty}</td>
      <td class="mono">‚Çπ${fmt(p.tradePrice,2)}</td>
      <td class="mono accent">‚Çπ${fmt(p.ltp,2)}</td>
      <td class="mono ${g.netDelta>=0?'green':'red'}">${fmt(g.netDelta,3)}</td>
      <td class="mono ${g.netGamma>=0?'green':'red'}">${fmt(g.netGamma,5)}</td>
      <td class="mono ${g.netTheta>=0?'green':'red'}">‚Çπ${fmt(g.netTheta,0)}</td>
      <td class="mono ${g.netVega>=0?'green':'red'}">‚Çπ${fmt(g.netVega,0)}</td>
      <td class="mono">${fmtPnl(pnl)}</td>
      <td style="font-size:10px;color:var(--text3);">${p.notes||''}</td>
      <td>
        <button class="btn btn-ghost" style="padding:3px 7px;font-size:8px;" onclick="editPosition(${idx})">EDIT</button>
        <button class="btn btn-danger" style="padding:3px 7px;font-size:8px;margin-left:3px;" onclick="deletePosition(${idx})">DEL</button>
      </td>
    </tr>`;
  });

  el('opt-total-pnl').innerHTML=fmtPnl(totalPnl);
  el('p-delta').textContent=fmt(netDelta,3);
  el('p-theta').textContent='‚Çπ'+fmt(netTheta,0);
  el('p-gamma').textContent=fmt(netGamma,5);
  el('p-vega').textContent='‚Çπ'+fmt(netVega,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EQUITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEquity() {
  const body=el('eq-body'); body.innerHTML='';
  let totInv=0,totCurr=0,totPnl=0,totDelta=0,totBeta=0;
  APP.equity.forEach((eq,idx)=>{
    const r=calcEquity(eq);
    totInv+=r.invested;totCurr+=r.currVal;totPnl+=r.pnl;totDelta+=r.delta;totBeta+=r.betaDelta;
    body.innerHTML+=`<tr>
      <td class="mono">${idx+1}</td><td class="bold">${eq.stock}</td>
      <td style="font-size:10px;">${eq.exch}</td>
      <td>${chip(eq.dir,eq.dir==='Long'?'green':'red')}</td>
      <td class="mono">${fmt(eq.qty)}</td>
      <td class="mono">‚Çπ${fmt(eq.cost,2)}</td>
      <td class="mono accent">‚Çπ${fmt(eq.cmp,2)}</td>
      <td class="mono">${eq.beta}</td>
      <td class="mono">‚Çπ${fmt(r.invested)}</td>
      <td class="mono">‚Çπ${fmt(r.currVal)}</td>
      <td class="mono">${fmtPnl(r.pnl)}</td>
      <td class="mono">${fmtPct(r.pnlPct)}</td>
      <td class="mono">‚Çπ${fmt(r.delta)}</td>
      <td class="mono">‚Çπ${fmt(r.betaDelta)}</td>
      <td style="font-size:10px;">${eq.sector||''}</td>
      <td>
        <button class="btn btn-ghost" style="padding:3px 7px;font-size:8px;" onclick="editEquity(${idx})">EDIT</button>
        <button class="btn btn-danger" style="padding:3px 7px;font-size:8px;margin-left:3px;" onclick="deleteEquity(${idx})">DEL</button>
      </td>
    </tr>`;
  });
  el('eq-t-inv').textContent='‚Çπ'+fmt(totInv);
  el('eq-t-curr').textContent='‚Çπ'+fmt(totCurr);
  el('eq-t-pnl').innerHTML=fmtPnl(totPnl);
  el('eq-t-pnlpct').innerHTML=fmtPct(totPnl/(totInv||1));
  el('eq-t-delta').textContent='‚Çπ'+fmt(totDelta);
  el('eq-t-betadelta').textContent='‚Çπ'+fmt(totBeta);
  el('e-inv').textContent='‚Çπ'+fmt(totInv);
  el('e-curr').textContent='‚Çπ'+fmt(totCurr);
  el('e-pnl').innerHTML=fmtPnl(totPnl);
  el('e-beta').textContent='‚Çπ'+fmt(totBeta);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCENARIO ‚Äî FULL BS P&L + DYNAMIC GREEKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderScenario() {
  const moves=[-0.10,-0.05,-0.03,-0.02,-0.01,0,0.01,0.02,0.03,0.05,0.10,0.15];
  const nifty=APP.settings.nifty||25725;

  // ‚îÄ‚îÄ P&L Table ‚îÄ‚îÄ
  let html='<thead><tr><th class="lbl">POSITION</th>';
  moves.forEach(m=>{
    const isZero=m===0;
    html+=`<th class="${isZero?'highlight':''}">${m>0?'+':''}${(m*100).toFixed(0)}%</th>`;
  });
  html+='</tr><tr><th class="lbl" style="color:var(--text3);font-size:9px;">Nifty spot</th>';
  moves.forEach(m=>{
    const s=Math.round(nifty*(1+m));
    html+=`<td class="${m===0?'highlight':''}" style="text-align:center;font-size:9px;color:var(--text3);">${s.toLocaleString('en-IN')}</td>`;
  });
  html+='</tr></thead><tbody>';

  let optTotals=new Array(moves.length).fill(0);
  let eqTotals =new Array(moves.length).fill(0);

  // Options/Futures: full BS P&L = (BS price at scenario spot ‚àí entry BS price) √ó net qty
  APP.positions.forEach(p=>{
    const dir=p.bs==='Buy'?1:-1;
    const netQty=p.lotSize*p.lots*dir;
    const label=`${p.inst} ${p.type} ${p.bs} x${p.lots}L`;
    const entryBsPrice=p.type==='Future'?(p.spot||nifty):bsPrice(p,p.spot||nifty);

    html+=`<tr><td class="lbl">${label}</td>`;
    moves.forEach((m,mi)=>{
      const scenSpot=nifty*(1+m);
      let pnl;
      if(p.type==='Future'){
        pnl=(scenSpot-(p.spot||nifty))*netQty;
      } else {
        const scen=bsPrice(p,scenSpot);
        pnl=(scen-entryBsPrice)*netQty;
      }
      optTotals[mi]+=pnl;
      html+=`<td class="${pnl>50?'pos':pnl<-50?'neg':'zero'}${m===0?' highlight':''}">${pnl>0?'+':''}${fmt(pnl)}</td>`;
    });
    html+='</tr>';
  });

  // Equity: CMP √ó beta √ó move%
  APP.equity.forEach(eq=>{
    const r=calcEquity(eq);
    const label=`${eq.stock} ${eq.dir} x${eq.qty}sh`;
    html+=`<tr><td class="lbl" style="color:var(--green);">${label}</td>`;
    moves.forEach((m,mi)=>{
      const pnl=r.delta*m;
      eqTotals[mi]+=pnl;
      html+=`<td class="${pnl>50?'pos':pnl<-50?'neg':'zero'}${m===0?' highlight':''}">${pnl>0?'+':''}${fmt(pnl)}</td>`;
    });
    html+='</tr>';
  });

  // Totals
  html+='<tr class="total-row"><td class="lbl">OPT/FUT TOTAL</td>';
  optTotals.forEach((v,mi)=>{html+=`<td class="${v>0?'pos':v<0?'neg':'zero'}${mi===5?' highlight':''}">${v>0?'+':''}‚Çπ${fmt(v)}</td>`;});
  html+='</tr><tr class="total-row"><td class="lbl" style="color:var(--green);">EQUITY TOTAL</td>';
  eqTotals.forEach((v,mi)=>{html+=`<td class="${v>0?'pos':v<0?'neg':'zero'}${mi===5?' highlight':''}">${v>0?'+':''}‚Çπ${fmt(v)}</td>`;});
  html+='</tr><tr class="total-row" style="background:rgba(0,200,255,.05);"><td class="lbl" style="color:var(--accent);">‚≠ê COMBINED</td>';
  moves.forEach((m,mi)=>{
    const v=optTotals[mi]+eqTotals[mi];
    html+=`<td class="${v>0?'pos':v<0?'neg':'zero'}${mi===5?' highlight':''}" style="font-weight:700;">${v>0?'+':''}‚Çπ${fmt(v)}</td>`;
  });
  html+='</tr></tbody>';
  el('scen-tbl').innerHTML=html;

  // ‚îÄ‚îÄ DYNAMIC GREEKS TABLE ‚Äî fully recalculated at each spot ‚îÄ‚îÄ
  let ghtml='<thead><tr><th class="lbl">GREEK AT SPOT ‚Üí</th>';
  moves.forEach(m=>{ghtml+=`<th class="${m===0?'highlight':''}">${m>0?'+':''}${(m*100).toFixed(0)}%<br><span style="font-weight:400;color:var(--text3);font-size:7px;">${Math.round(nifty*(1+m)).toLocaleString('en-IN')}</span></th>`;});
  ghtml+='</tr></thead><tbody>';

  const greekDefs=[
    {
      lbl:'Net Delta (units)',
      hint:'Delta of entire options/futures book recalculated at each spot via Black-Scholes. Changes because of gamma.',
      fn:(scen)=>{
        let d=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); d+=g.netDelta; });
        return {val:d,fmt:v=>fmt(v,3),color:v=>v>=0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Delta Change vs 0%',
      hint:'Change in net delta from current spot. Negative = delta falling (options hedging the future). Positive = delta rising (unhedged).',
      fn:(scen,baseD)=>{
        let d=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); d+=g.netDelta; });
        const chg=d-baseD;
        // Green = delta falling (puts/calls reducing exposure) = good hedge
        // Red = delta rising (exposure increasing = more unhedged)
        return {val:chg,fmt:v=>(v>0?'+':'')+fmt(v,3),color:v=>v<0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Delta Exp ‚Çπ (Opt/Fut)',
      hint:'Net delta √ó scenario spot = signed ‚Çπ directional exposure. Positive = net long bias. Watch how puts reduce this on downmoves.',
      fn:(scen)=>{
        let d=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); d+=g.netDelta; });
        const exp=d*scen;
        // Show signed value with sign indicator
        return {val:exp,fmt:v=>(v>=0?'+':'')+'‚Çπ'+fmt(v),color:v=>v>=0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Net Gamma',
      hint:'Rate of delta change. Negative (short gamma) means your delta worsens as spot moves away from strikes.',
      fn:(scen)=>{
        let g2=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); g2+=g.netGamma; });
        return {val:g2,fmt:v=>fmt(v,5),color:v=>v>=0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Net Theta / Day ‚Çπ',
      hint:'Daily time decay at each scenario. Theta increases as options approach ATM.',
      fn:(scen)=>{
        let t=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); t+=g.netTheta; });
        return {val:t,fmt:v=>'‚Çπ'+fmt(v,0),color:v=>v>=0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Net Vega / 1% IV ‚Çπ',
      hint:'Sensitivity to a 1% IV (VIX) change at each scenario. Negative = VIX spike hurts.',
      fn:(scen)=>{
        let v2=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); v2+=g.netVega; });
        return {val:v2,fmt:v=>'‚Çπ'+fmt(v,0),color:v=>v>=0?'var(--green)':'var(--red)'};
      }
    },
    {
      lbl:'Equity Delta ‚Çπ',
      hint:'NiftyBees + ETF exposure changes linearly (beta √ó price √ó move). Not BS-driven.',
      fn:(scen)=>{
        let d=0;
        APP.equity.forEach(eq=>{ const r=calcEquity(eq); d+=r.delta*(scen/nifty); });
        return {val:d,fmt:v=>'‚Çπ'+fmt(v),color:_=>'var(--green)'};
      }
    },
    {
      lbl:'COMBINED Delta ‚Çπ',
      hint:'Options/Futures delta exposure + Equity delta at each scenario. Positive = net long. Negative = net short.',
      fn:(scen)=>{
        let optD=0,eqD=0;
        APP.positions.forEach(p=>{ const g=calcBS(p,scen); optD+=g.netDelta; });
        APP.equity.forEach(eq=>{ const r=calcEquity(eq); eqD+=r.delta*(scen/nifty); });
        const total=optD*scen+eqD;
        return {val:total,fmt:v=>(v>=0?'+':'')+'‚Çπ'+fmt(v),color:v=>v>=0?'var(--accent)':'var(--orange)'};
      }
    },
  ];

  // Calculate base delta at 0% for delta-change row
  let baseDelta=0;
  APP.positions.forEach(p=>{ const g=calcBS(p,nifty); baseDelta+=g.netDelta; });

  greekDefs.forEach((row,ri)=>{
    ghtml+=`<tr><td class="lbl" title="${row.hint}">${row.lbl}<br><span style="font-size:8px;color:var(--text3);">${row.hint.substring(0,50)}...</span></td>`;
    moves.forEach((m,mi)=>{
      const scen=nifty*(1+m);
      const result=row.fn(scen,baseDelta);
      ghtml+=`<td class="${mi===5?'highlight':''}" style="color:${result.color(result.val)};font-weight:${mi===5?'700':'400'};">${result.fmt(result.val)}</td>`;
    });
    ghtml+='</tr>';
  });
  ghtml+='</tbody>';
  el('scen-greeks-tbl').innerHTML=ghtml;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GREEKS DEEP DIVE PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGreeksDeepDive() {
  const nifty=APP.settings.nifty||25725;

  // Full per-position Greeks table
  const body=el('greeks-body'); body.innerHTML='';
  let totDelta=0,totGamma=0,totTheta=0,totVega=0;

  APP.positions.forEach((p,idx)=>{
    const g=calcBS(p);
    const dir=p.bs==='Buy'?1:-1;
    const netQty=p.lotSize*p.lots*dir;
    totDelta+=g.netDelta; totGamma+=g.netGamma; totTheta+=g.netTheta; totVega+=g.netVega;

    body.innerHTML+=`<tr>
      <td class="mono">${idx+1}</td>
      <td class="bold">${p.inst}</td><td>${p.type}</td>
      <td>${chip(p.bs,p.bs==='Buy'?'green':'orange')}</td>
      <td class="mono">${netQty}</td>
      <td class="mono">${fmt(p.spot)}</td>
      <td class="mono">${p.strike?fmt(p.strike):'Future'}</td>
      <td class="mono">${p.iv?p.iv+'%':'‚Äî'}</td>
      <td class="mono">${p.dteCurr??p.dte}</td>
      <td class="mono accent">‚Çπ${fmt(g.price,2)}</td>
      <td class="mono">${fmt(g.deltaUnit,4)}</td>
      <td class="mono bold ${g.netDelta>=0?'green':'red'}">${fmt(g.netDelta,3)}</td>
      <td class="mono">${g.netGamma?fmt(g.netGamma,6):'‚Äî'}</td>
      <td class="mono ${g.netGamma>=0?'green':'red'}">${g.netGamma?fmt(g.netGamma,5):'‚Äî'}</td>
      <td class="mono ${g.netTheta>=0?'green':'red'}">‚Çπ${fmt(g.netTheta,0)}/day</td>
      <td class="mono ${g.netVega>=0?'green':'red'}">‚Çπ${fmt(g.netVega,0)}</td>
    </tr>`;
  });
  el('g-net-delta').textContent=fmt(totDelta,3);
  el('g-net-gamma').textContent=fmt(totGamma,5);
  el('g-net-theta').textContent='‚Çπ'+fmt(totTheta,0)+'/day';
  el('g-net-vega').textContent='‚Çπ'+fmt(totVega,0);

  // Delta sensitivity table ‚Äî small moves around spot
  const smallMoves=[-0.05,-0.04,-0.03,-0.02,-0.01,0,0.01,0.02,0.03,0.04,0.05];
  let dtbl='<thead><tr><th class="lbl">POSITION</th>';
  smallMoves.forEach(m=>{ dtbl+=`<th class="${m===0?'highlight':''}">${m>0?'+':''}${(m*100).toFixed(0)}%</th>`; });
  dtbl+='</tr></thead><tbody>';
  let netDeltas=new Array(smallMoves.length).fill(0);
  APP.positions.forEach(p=>{
    const dir=p.bs==='Buy'?1:-1;
    const label=`${p.inst} ${p.type} ${p.bs} x${p.lots}L`;
    dtbl+=`<tr><td class="lbl">${label}</td>`;
    smallMoves.forEach((m,mi)=>{
      const scen=nifty*(1+m);
      const g=calcBS(p,scen);
      netDeltas[mi]+=g.netDelta;
      dtbl+=`<td class="${m===0?'highlight':''}" style="color:${g.netDelta>=0?'var(--green)':'var(--red)'}">${fmt(g.netDelta,3)}</td>`;
    });
    dtbl+='</tr>';
  });
  dtbl+='<tr class="total-row"><td class="lbl">NET PORTFOLIO DELTA</td>';
  netDeltas.forEach((v,mi)=>{
    dtbl+=`<td class="${mi===5?'highlight':''}" style="color:${v>=0?'var(--green)':'var(--red)'};">${fmt(v,3)}</td>`;
  });
  dtbl+='</tr></tbody>';
  el('delta-scen-tbl').innerHTML=dtbl;

  // Live Greeks summary card
  el('greeks-live-table').innerHTML=`
    <div style="background:var(--bg3);border:1px solid var(--border);padding:14px;">
      <div class="stitle mb0">LIVE GREEKS AT NIFTY ${nifty.toLocaleString('en-IN')}</div>
      <div style="margin-top:12px;display:grid;gap:10px;">
        ${[
          {label:'Net Delta',val:fmt(totDelta,3),sub:'Total directional units',color:totDelta>=0?'var(--green)':'var(--red)'},
          {label:'Net Gamma',val:fmt(totGamma,5),sub:'Delta change rate (negative = risky)',color:totGamma>=0?'var(--green)':'var(--red)'},
          {label:'Net Theta/Day',val:'‚Çπ'+fmt(totTheta,0),sub:'Daily time decay income',color:totTheta>=0?'var(--green)':'var(--red)'},
          {label:'Net Vega/1%IV',val:'‚Çπ'+fmt(totVega,0),sub:'VIX 1% move impact',color:totVega>=0?'var(--green)':'var(--red)'},
        ].map(r=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);">
            <div><div style="font-family:var(--mono);font-size:9px;color:var(--text3);">${r.label}</div><div style="font-size:10px;color:var(--text3);">${r.sub}</div></div>
            <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:${r.color};">${r.val}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAlerts() {
  const S=APP.settings;
  const nifty=S.nifty||25725,vix=S.vix||12.6,dte=S.dte||40;

  const alerts=[
    {title:'PUT SIDE STOP-LOSS',level:S.shortPE,triggered:nifty<S.shortPE,near:nifty<S.shortPE+300,action:'Close short PE for ALL 5 clients immediately. Do not wait for EOD.',type:'danger'},
    {title:'CALL SIDE STOP-LOSS',level:S.shortCE,triggered:nifty>S.shortCE,near:nifty>S.shortCE-300,action:'Close short CE for A & B. C, D, E have no short calls ‚Äî hold.',type:'danger'},
    {title:'VIX ALERT',level:vix,triggered:vix>=20,near:vix>=17,action:vixRegime(vix).action,type:vix<13?'ok':vix<17?'ok':vix<20?'warning':'danger'},
    {title:'DTE DANGER ZONE',level:dte+' days left',triggered:dte<=7,near:dte<=14,action:dte<=7?'CLOSE ALL open options now.':dte<=14?'Increase monitoring. Prepare exit plan.':'Hold. Theta in your favour.',type:dte<=7?'danger':dte<=14?'warning':'ok'},
    {title:'PROFIT BOOKING',level:'70% of credit',triggered:false,near:false,action:'When 70% of max credit captured ‚Üí close and redeploy into next expiry.',type:'info'},
    {title:'MARGIN UTILISATION',level:'< 80%',triggered:false,near:false,action:'If any account hits 85% margin, close the most OTM leg first.',type:'ok'},
  ];

  const aEl=el('alert-list'); aEl.innerHTML='';
  alerts.forEach(a=>{
    const cls=a.triggered?'danger':a.near?'warning':a.type==='ok'?'ok':'info';
    const badge=a.triggered?'üö® TRIGGERED':a.near?'‚ö† NEAR':'‚úì CLEAR';
    aEl.innerHTML+=`<div class="alert-box ${cls} mb8">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <strong>${a.title}</strong>
        <span style="font-family:var(--mono);font-size:9px;">${badge}</span>
      </div>
      <div style="font-family:var(--mono);font-size:13px;margin-bottom:5px;">${typeof a.level==='number'?a.level.toLocaleString('en-IN'):a.level}</div>
      <div style="font-size:10px;"><strong>ACTION:</strong> ${a.action}</div>
    </div>`;
  });

  const levels=[
    {name:'Long PE Hedge Floor',price:S.longPE,side:'support'},
    {name:'Short PE ‚Äî EXIT TRIGGER',price:S.shortPE,side:'support'},
    {name:'Short PE +200 Buffer',price:S.shortPE+200,side:'support'},
    {name:'NIFTY SPOT',price:nifty,side:'neutral'},
    {name:'Spread Midpoint',price:Math.round((S.shortPE+S.shortCE)/2),side:'neutral'},
    {name:'Short CE ‚àí200 Buffer',price:S.shortCE-200,side:'resist'},
    {name:'Short CE ‚Äî EXIT TRIGGER',price:S.shortCE,side:'resist'},
    {name:'Long CE Hedge Cap',price:S.longCE,side:'resist'},
  ];
  const lEl=el('level-list'); lEl.innerHTML='';
  levels.forEach(lv=>{
    const diff=nifty-lv.price;
    const pct=((Math.abs(diff)/nifty)*100).toFixed(2);
    const breached=(lv.side==='support'&&nifty<lv.price)||(lv.side==='resist'&&nifty>lv.price);
    const cls=breached?'danger':lv.side==='support'?'warning':lv.side==='resist'?'warning':'info';
    lEl.innerHTML+=`<div class="alert-box ${cls} mb8">
      <div style="display:flex;justify-content:space-between;">
        <strong>${lv.name}</strong>
        <span style="font-family:var(--mono);font-size:13px;">${lv.price.toLocaleString('en-IN')}</span>
      </div>
      <div style="font-family:var(--mono);font-size:9px;margin-top:3px;color:var(--text3);">
        ${lv.price===nifty?'‚óâ CURRENT':`${diff>0?'‚ñ≤':'‚ñº'} ${Math.abs(diff).toLocaleString('en-IN')} pts (${pct}%) ${diff>0?'above':'below'} spot`}
        ${breached?' ‚Äî üö® BREACHED':''}
      </div>
    </div>`;
  });

  const rules=[
    {cls:'danger',text:'<strong>Never hold past 7 DTE.</strong> Close ALL positions 7 days before expiry. Gamma spikes unpredictably. No exceptions ever.'},
    {cls:'warning',text:'<strong>70% profit = close.</strong> Book it. Do not hold for last 30% ‚Äî gamma and weekend risk are not worth it.'},
    {cls:'danger',text:'<strong>Nifty below Short PE = exit immediately.</strong> No averaging. No waiting.'},
    {cls:'warning',text:'<strong>Nifty above Short CE = exit CE for A & B.</strong> C, D, E have no short calls ‚Äî they hold.'},
    {cls:'warning',text:'<strong>VIX > 17 = stop strangles.</strong> Spreads only. Buy 24,500 PE tail hedge for A & B.'},
    {cls:'ok',text:'<strong>Margin < 80% always.</strong> Close most OTM leg if any account hits 85%.'},
    {cls:'info',text:'<strong>No stock selection.</strong> Alpha comes from the options structure. NiftyBees + ETF core only.'},
  ];
  const rEl=el('rules-list'); rEl.innerHTML='';
  rules.forEach(r=>{ rEl.innerHTML+=`<div class="alert-box ${r.cls} mb8">${r.text}</div>`; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSettingsForm() {
  const S=APP.settings;
  const map={nifty:'s-nifty',vix:'s-vix',dte:'s-dte',credit:'s-credit',rfr:'s-rfr',defIV:'s-div',shortPE:'s-short-pe',longPE:'s-long-pe',shortCE:'s-short-ce',longCE:'s-long-ce'};
  // Expiry date and live VIX toggle
  const exp = el('s-default-expiry'); if(exp) exp.value = S.defaultExpiry||'2026-03-26';
  const vixCb = el('s-use-vix'); if(vixCb) vixCb.checked = !!S.useLiveVix;
  Object.entries(map).forEach(([k,id])=>{ const e=el(id); if(e&&S[k]!==undefined) e.value=S[k]; });
  renderClientCfg();
  renderEqSymbolsList();
  updateStorageInfo();
}

function saveSettings() {
  const g=id=>parseFloat(el(id).value)||0;
  // IMPORTANT: merge into existing settings ‚Äî don't overwrite useLiveVix/defaultExpiry
  Object.assign(APP.settings, {
    nifty:g('s-nifty'), vix:g('s-vix'), dte:g('s-dte'), credit:g('s-credit'),
    rfr:g('s-rfr'), defIV:g('s-div'),
    shortPE:g('s-short-pe'), longPE:g('s-long-pe'),
    shortCE:g('s-short-ce'), longCE:g('s-long-ce'),
    defaultExpiry: el('s-default-expiry').value || '2026-03-26',
    useLiveVix: el('s-use-vix').checked,
  });
  // Update expiry on all positions that don't have one yet
  APP.positions.forEach(p => { if (!p.expiry) p.expiry = APP.settings.defaultExpiry; });
  saveState(); renderAll(); toast('Settings saved ‚úì');
}

function loadDefaults() {
  APP={settings:{...DEFAULT_SETTINGS},positions:JSON.parse(JSON.stringify(DEFAULT_POSITIONS)),equity:JSON.parse(JSON.stringify(DEFAULT_EQUITY)),clients:JSON.parse(JSON.stringify(DEFAULT_CLIENTS))};
  saveState(); loadSettingsForm(); renderAll(); toast('Defaults loaded ‚úì');
}

function renderClientCfg() {
  const body=el('client-cfg-body'); if(!body) return; body.innerHTML='';
  APP.clients.forEach((c,idx)=>{
    body.innerHTML+=`<tr>
      <td class="bold accent mono" style="font-size:16px;">${c.id}</td>
      <td><input style="background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:3px 7px;width:110px;" value="${c.aum}" onchange="APP.clients[${idx}].aum=+this.value;saveState();renderAll();"></td>
      <td class="mono">${c.lots}</td>
      <td style="font-size:10px;">${c.structure}</td>
      <td><input style="background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:3px 7px;width:90px;" value="${c.targetLo}" onchange="APP.clients[${idx}].targetLo=+this.value;saveState();renderAll();"></td>
      <td><input style="background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:3px 7px;width:90px;" value="${c.targetHi}" onchange="APP.clients[${idx}].targetHi=+this.value;saveState();renderAll();"></td>
    </tr>`;
  });
}

function updateStorageInfo() {
  try {
    const raw=localStorage.getItem(STORAGE_KEY)||'';
    const fbStatus = fbConnected ? ' ¬∑ ‚òÅ Firebase sync ON' : ' ¬∑ ‚òÅ Firebase not connected';
    el('storage-info').textContent=`localStorage ¬∑ ${(raw.length/1024).toFixed(1)} KB ¬∑ Persists across sessions${fbStatus}`;
  } catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POSITION CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Open modal for a fresh ADD ‚Äî resets all fields to blank/defaults
function openModal(type) {
  if(type==='opt'){
    el('opt-edit-idx').value=''; // blank = new
    el('f-inst').value='NIFTY';
    el('f-type').value='Call';
    el('f-bs').value='Sell';
    el('f-spot').value=APP.settings.nifty||'';
    el('f-strike').value='';
    el('f-iv').value=APP.settings.defIV||12.6;
    el('f-dte').value='';
    el('f-expiry').value=APP.settings.defaultExpiry||'2026-03-26';
    el('f-lotsize').value=65;
    el('f-lots').value=1;
    el('f-tradeprice').value='';
    el('f-ltp').value='';
    el('f-notes').value='';
    el('modal-title-opt').textContent='ADD NEW OPTION OR FUTURE';
  }
  if(type==='eq'){
    el('eq-edit-idx').value='';
    el('ef-stock').value=''; el('ef-yahoo').value='';
    el('ef-exch').value='NSE'; el('ef-dir').value='Long';
    el('ef-qty').value=''; el('ef-cost').value='';
    el('ef-cmp').value=''; el('ef-beta').value=1;
    el('ef-sector').value=''; el('ef-notes').value='';
    el('modal-title-eq').textContent='ADD NEW EQUITY POSITION';
  }
  el('modal-'+type).classList.add('open');
}

function closeModal(type){el('modal-'+type).classList.remove('open');}

function savePosition() {
  const idx=el('opt-edit-idx').value;
  const pos={
    inst:el('f-inst').value, type:el('f-type').value, bs:el('f-bs').value,
    spot:+el('f-spot').value, strike:+el('f-strike').value||null,
    iv:+el('f-iv').value||null, dte:+el('f-dte').value,
    expiry:el('f-expiry').value||(APP.settings.defaultExpiry||'2026-03-26'),
    lotSize:+el('f-lotsize').value, lots:+el('f-lots').value,
    tradePrice:+el('f-tradeprice').value, ltp:+el('f-ltp').value,
    notes:el('f-notes').value,
  };
  if(idx!=='') APP.positions[+idx]=pos; else APP.positions.push(pos);
  closeModal('opt'); saveState(); renderAll(); toast(idx!==''?'Position updated ‚úì':'Position added ‚úì');
}

// editPosition: loads existing data into form WITHOUT resetting anything
function editPosition(idx) {
  const p=APP.positions[idx];
  // Set the edit index FIRST
  el('opt-edit-idx').value=idx;
  // Populate every field from saved position ‚Äî no defaults injected
  el('f-inst').value=p.inst;
  el('f-type').value=p.type;
  el('f-bs').value=p.bs;
  el('f-spot').value=p.spot;
  el('f-strike').value=p.strike!==null&&p.strike!==undefined?p.strike:'';
  el('f-iv').value=p.iv!==null&&p.iv!==undefined?p.iv:'';
  el('f-dte').value=p.dte!==null&&p.dte!==undefined?p.dte:'';
  el('f-expiry').value=p.expiry||APP.settings.defaultExpiry||'2026-03-26';
  el('f-lotsize').value=p.lotSize;
  el('f-lots').value=p.lots;
  el('f-tradeprice').value=p.tradePrice!==null&&p.tradePrice!==undefined?p.tradePrice:'';
  el('f-ltp').value=p.ltp!==null&&p.ltp!==undefined?p.ltp:'';
  el('f-notes').value=p.notes||'';
  // Update modal title to show it's an edit
  el('modal-title-opt').textContent=`EDIT POSITION #${idx+1} ‚Äî ${p.inst} ${p.type} ${p.bs}`;
  // Open WITHOUT resetting
  el('modal-opt').classList.add('open');
}
function deletePosition(idx){if(!confirm('Delete?'))return;APP.positions.splice(idx,1);saveState();renderAll();toast('Deleted');}
function clearAllPositions(){if(!confirm('Clear ALL positions?'))return;APP.positions=[];saveState();renderAll();toast('Cleared');}

function saveEquity() {
  const idx=el('eq-edit-idx').value;
  const eq={
    stock:el('ef-stock').value, yahoo:el('ef-yahoo').value, exch:el('ef-exch').value,
    dir:el('ef-dir').value, qty:+el('ef-qty').value,
    cost:+el('ef-cost').value, cmp:+el('ef-cmp').value,
    beta:+el('ef-beta').value||1, sector:el('ef-sector').value, notes:el('ef-notes').value,
  };
  if(idx!=='') APP.equity[+idx]=eq; else APP.equity.push(eq);
  closeModal('eq'); saveState(); renderAll(); renderEqSymbolsList(); toast('Stock saved ‚úì');
}
function editEquity(idx){
  const eq=APP.equity[idx];
  // Set index first ‚Äî openModal would reset everything, so we bypass it
  el('eq-edit-idx').value=idx;
  el('ef-stock').value=eq.stock;
  el('ef-yahoo').value=eq.yahoo||'';
  el('ef-exch').value=eq.exch;
  el('ef-dir').value=eq.dir;
  el('ef-qty').value=eq.qty;
  el('ef-cost').value=eq.cost;
  el('ef-cmp').value=eq.cmp!==null&&eq.cmp!==undefined?eq.cmp:'';
  el('ef-beta').value=eq.beta!==null&&eq.beta!==undefined?eq.beta:1;
  el('ef-sector').value=eq.sector||'';
  el('ef-notes').value=eq.notes||'';
  el('modal-title-eq').textContent='EDIT STOCK ‚Äî '+eq.stock;
  // Open modal directly ‚Äî do NOT call openModal() as it resets all fields
  el('modal-eq').classList.add('open');
}
function deleteEquity(idx){if(!confirm('Delete?'))return;APP.equity.splice(idx,1);saveState();renderAll();renderEqSymbolsList();toast('Deleted');}
function clearAllEquity(){if(!confirm('Clear ALL equity?'))return;APP.equity=[];saveState();renderAll();toast('Cleared');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clearAll(){
  if (!confirm('Clear ALL data from this device AND cloud? This cannot be undone.')) return;
  localStorage.removeItem(STORAGE_KEY);
  APP={settings:{...DEFAULT_SETTINGS},positions:[],equity:[],clients:JSON.parse(JSON.stringify(DEFAULT_CLIENTS))};
  saveState();
  if(fbDatabase && fbConnected) {
    fbDatabase.ref('riskdesk/app').set(APP).catch(e=>console.warn('Firebase clear failed:',e));
  }
  renderAll();toast('All data cleared (local + cloud)');
}
function exportData(){const b=new Blob([JSON.stringify(APP,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='nifty_cmd_'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('Exported ‚úì');}
function loadFromFile(){el('file-import').click();}
function importData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{APP=JSON.parse(ev.target.result);if(!APP.clients)APP.clients=JSON.parse(JSON.stringify(DEFAULT_CLIENTS));saveState();renderAll();toast('Imported ‚úì');}catch(err){toast('Invalid JSON',true);}};r.readAsText(f);}

document.querySelectorAll('.modal-bg').forEach(bg=>{
  bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadSettingsForm();
renderAll();
updateSyncUI();

// ‚îÄ‚îÄ Auto-init Firebase if config was pre-baked or previously saved ‚îÄ‚îÄ
(async () => {
  const cfg = FIREBASE_PRECONFIG || loadFirebaseConfig();
  if (cfg && cfg.apiKey) {
    await initFirebase(cfg);
  }
})();

// ‚îÄ‚îÄ Register Service Worker for PWA offline support ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  // Inline service worker as a blob ‚Äî no separate sw.js file needed
  const swCode = `
    const CACHE = 'risk-desk-v1';
    const ASSETS = ['/'];
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(keys =>
        Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
      ));
      self.clients.claim();
    });
    self.addEventListener('fetch', e => {
      // Network first for API calls, cache first for app shell
      if (e.request.url.includes('firebaseio.com') ||
          e.request.url.includes('yahoo.com') ||
          e.request.url.includes('allorigins')) {
        e.respondWith(fetch(e.request).catch(() => new Response('', {status: 503})));
        return;
      }
      e.respondWith(
        caches.match(e.request).then(cached => cached || fetch(e.request).then(res => {
          if (res.ok && e.request.method === 'GET') {
            const clone = res.clone();
            caches.open(CACHE).then(c => c.put(e.request, clone));
          }
          return res;
        }))
      );
    });
  `;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl, {scope: './'})
    .then(reg => console.log('SW registered:', reg.scope))
    .catch(e => console.warn('SW registration failed (expected on file://):', e));
}
</script>
</body>
</html>
